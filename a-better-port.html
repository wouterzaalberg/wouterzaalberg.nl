<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>A Better Port - De Amsterdamse Haven in Transitie | Wouter Zaalberg</title>
    <meta name="description" content="Fotoserie over de haven van Amsterdam: de energietransitie, havenwerkers, scheepvaart en de toekomst van een van Europa's grootste havens. Door documentaire fotograaf Wouter Zaalberg.">
    <meta name="keywords" content="haven Amsterdam, Port of Amsterdam, energietransitie, havenwerkers, scheepvaart, documentaire fotografie, Wouter Zaalberg">
    <meta name="author" content="Wouter Zaalberg">
    <link rel="canonical" href="https://wouterzaalberg.nl/a-better-port.html">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://wouterzaalberg.nl/a-better-port.html">
    <meta property="og:title" content="A Better Port - De Amsterdamse Haven in Transitie">
    <meta property="og:description" content="Fotoserie over de haven van Amsterdam door documentaire fotograaf Wouter Zaalberg.">
    <meta property="og:image" content="https://wouterzaalberg.nl/images/a-better-port.jpg">
    <meta property="og:locale" content="nl_NL">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="A Better Port - De Amsterdamse Haven">
    <meta name="twitter:description" content="Fotoserie over de haven van Amsterdam door Wouter Zaalberg.">
    <meta name="twitter:image" content="https://wouterzaalberg.nl/images/a-better-port.jpg">

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/a-better-port.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="abp-page">
    <div class="horizontal-nav">
        <div>
            <a href="/" class="back-link">← Terug</a>
            <span class="nav-title">A Better Port</span>
        </div>
    </div>

    <!-- Share Button -->
    <button class="share-button" id="shareButton" aria-label="Deel deze pagina">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
    </button>
    <div class="share-dropdown" id="shareDropdown">
        <a href="#" id="shareWhatsApp" target="_blank" rel="noopener"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>WhatsApp</a>
        <a href="#" id="shareFacebook" target="_blank" rel="noopener"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>Facebook</a>
        <a href="#" id="shareTwitter" target="_blank" rel="noopener"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>X</a>
        <a href="#" id="shareLinkedIn" target="_blank" rel="noopener"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>LinkedIn</a>
        <a href="#" id="shareEmail"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>Email</a>
        <button id="copyLink"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg><span>Kopieer link</span></button>
    </div>

    <!-- Progress indicator -->
    <div class="abp-progress" id="progressIndicator">
        <span class="abp-progress-number" id="progressNumber">0</span><span class="abp-progress-percent">%</span>
    </div>

    <!-- Dark Overlay - opacity controlled via JS -->
    <div class="abp-dark-overlay" id="darkOverlay"></div>

    <!-- Original Rotating Background (visible after intro) -->
    <div class="abp-background" id="originalBackground">
        <picture>
            <source srcset="a-better-port/achtergrond 1.webp" type="image/webp">
            <img src="a-better-port/achtergrond 1.jpg" alt="">
        </picture>
        <picture>
            <source srcset="a-better-port/achtergrond 2.webp" type="image/webp">
            <img src="a-better-port/achtergrond 2.jpg" alt="">
        </picture>
        <picture>
            <source srcset="a-better-port/achtergrond 3.webp" type="image/webp">
            <img src="a-better-port/achtergrond 3.jpg" alt="">
        </picture>
        <picture>
            <source srcset="a-better-port/achtergrond 1.webp" type="image/webp">
            <img src="a-better-port/achtergrond 1.jpg" alt="">
        </picture>
        <picture>
            <source srcset="a-better-port/achtergrond 2.webp" type="image/webp">
            <img src="a-better-port/achtergrond 2.jpg" alt="">
        </picture>
        <picture>
            <source srcset="a-better-port/achtergrond 3.webp" type="image/webp">
            <img src="a-better-port/achtergrond 3.jpg" alt="">
        </picture>
    </div>

    <!-- Leaflet Map Background (only visible at intro/photo 1) -->
    <div id="harborMap" class="abp-map-background"></div>

    <!-- Ship Animation Canvas (only visible at intro/photo 1) -->
    <canvas id="shipCanvas" class="abp-ship-canvas"></canvas>

    <!-- Map Interlude Overlay (outside scroll container for proper z-index) -->
    <div class="abp-map-interlude-overlay" id="mapInterludeOverlay">
        <h2 class="abp-map-interlude-title">De Haven in Beeld</h2>
        <p class="abp-map-interlude-subtitle">Klik op een locatie om de foto te zien</p>
        <p class="abp-scroll-hint-text">De serie gaat na de kaart verder</p>
    </div>

    <!-- Zoom Controls (only visible at Map Interlude) -->
    <div class="abp-zoom-controls" id="zoomControls">
        <button class="abp-zoom-btn" id="zoomInBtn">+</button>
        <button class="abp-zoom-btn" id="zoomOutBtn">−</button>
        <button class="abp-zoom-btn abp-zoom-reset" id="zoomResetBtn">Reset</button>
    </div>

    <div class="horizontal-scroll-container" id="scrollContainer">
        <div class="horizontal-scroll-content">
            <!-- Intro Section - Photo transforms into Text Panel -->
            <div class="abp-intro-section" id="introSection">
                <!-- Title - links naast de foto, rechts uitgelijnd -->
                <h1 class="abp-hero-title" id="introTitle">
                    <span>A</span>
                    <span>Better</span>
                    <span>Port</span>
                </h1>

                <!-- Photo 1 - Hidden initially, appears after text panel -->
                <div class="abp-intro-photo">
                    <div class="abp-intro-photo-wrapper">
                        <picture>
                            <source srcset="a-better-port/1.webp" type="image/webp">
                            <img src="a-better-port/1.jpg" alt="A Better Port" loading="eager">
                        </picture>
                    </div>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Carlos, Port Officier</div>
                        <div class="abp-caption-text">Op dek tijdens een storm</div>
                    </div>
                </div>

                <!-- Intro Text Panel - Visible initially, yellow semi-transparent -->
                <div class="abp-intro-panel">
                    <div class="abp-intro-content">
                        <div class="abp-intro-text">
                            <p class="mobile-only">Amsterdam is de grootste benzinehaven ter wereld. De mate waarin de haven verandert, geeft inzicht in de snelheid van de energietransitie. Ik liep een jaar (af en aan) rond in de Amsterdamse haven om de omslag in beeld te brengen.</p>
                            <p class="desktop-only">Het is het minst bekende en meest onbeminde stuk Amsterdam: de haven. Anders dan in Rotterdam is het geen onderdeel van het DNA van de stad. Dat wil niet zeggen dat het gebied niet belangrijk is: vanaf hier wordt de Nederlandse en Europese economie gevoed met grondstoffen en, vooral, energie. Amsterdam is de grootste benzinehaven ter wereld. Daarmee is het ook een spiegel van onze samenleving: de mate waarin de haven verandert, geeft inzicht in de snelheid van de energietransitie.</p>
                            <p class="desktop-only">Zelf is de Port of Amsterdam er hard mee bezig. Steenkool eruit, bio-fuels erin. Het moet duurzaam, circulair, draaiend op waterstof en stroom uit de parken op zee. Zoals het havenbedrijf zelf zegt: be part of a better port. Maar hoe verander je een haven die geknipt is voor fossiele overslag, voor een samenleving die gebouwd is op fossiele energie?</p>
                            <p class="desktop-only">Tegen de achtergrond van een haven in transitie, waarin de fossiele bulk beetje bij beetje plaatsmaakt voor de economie van de toekomst, legt fotograaf Wouter Zaalberg de mensen, het werk en de plekken vast.</p>
                            <p class="desktop-only">Dit tijdsbeeld laat het begin van verandering zien, maar toont ook hoe weerbarstig de realiteit is van een haven, en een land, dat ondanks alles, nog steeds bijna volledig afhankelijk is van fossiele energie.</p>
                            <p class="abp-intro-credit">Wouter Zaalberg, Amsterdam, maart 2024</p>
                        </div>
                    </div>
                </div>

                <!-- Photo 2 - Hidden initially, appears after photo 1 -->
                <div class="abp-intro-photo2">
                    <div class="abp-intro-photo-wrapper">
                        <picture>
                            <source srcset="a-better-port/2.webp" type="image/webp">
                            <img src="a-better-port/2.jpg" alt="A Better Port" loading="eager">
                        </picture>
                    </div>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Rietlanden terminal</div>
                        <div class="abp-caption-text">De kolenbergen van de Rietlanden terminal. Voor 2030 zal de steenkool hier plaatsmaken voor andere bulkgoederen.</div>
                    </div>
                </div>
            </div>

            <!-- Mobile only: Foto 1 met gele achtergrond -->
            <div class="abp-mobile-photo1">
                <div class="abp-mobile-photo1-img">
                    <picture>
                        <source srcset="a-better-port/1.webp" type="image/webp">
                        <img src="a-better-port/1.jpg" alt="A Better Port" loading="eager">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Carlos, Port Officier</div>
                        <div class="abp-caption-text">Op dek tijdens een storm</div>
                    </div>
                </div>
            </div>

            <!-- Mobile only: Tekst panel -->
            <div class="abp-mobile-text">
                <div class="abp-mobile-text-content">
                    <p>Amsterdam is de grootste benzinehaven ter wereld. Daarmee is de haven ook een spiegel van onze samenleving: de mate waarin zij verandert, geeft inzicht in de snelheid van de energietransitie.</p>
                    <p class="abp-mobile-credit">Wouter Zaalberg, Amsterdam, 2024</p>
                </div>
            </div>

            <!-- Mobile only: Foto 2 -->
            <div class="abp-mobile-photo2">
                <div class="abp-mobile-photo2-img">
                    <picture>
                        <source srcset="a-better-port/2.webp" type="image/webp">
                        <img src="a-better-port/2.jpg" alt="A Better Port" loading="eager">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Rietlanden terminal</div>
                        <div class="abp-caption-text">De kolenbergen van de Rietlanden terminal. Voor 2030 zal de steenkool hier plaatsmaken voor andere bulkgoederen.</div>
                    </div>
                </div>
            </div>

            <!-- Photo pair 3+4 -->
            <div class="abp-photo-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/3.webp" type="image/webp">
                        <img src="a-better-port/3.jpg" alt="A Better Port" class="photo" loading="eager">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">HES kolenterminal</div>
                        <div class="abp-caption-text">Op de enige andere kolenterminal, de HES, laadt een gigantische kraan een schip vol steenkool. 14,1 miljoen ton kolen werd er in Amsterdam overgeslagen. Dat is een kolentrein zo lang als de afstand Groningen - Lissabon.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/4.webp" type="image/webp">
                        <img src="a-better-port/4.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Patricia, HES terminal</div>
                        <div class="abp-caption-text">Patricia werkt al 25 jaar 'in de buitendienst' op de HES terminal. Ze is verantwoordelijk voor het laden en lossen van steenkool. Haar werk gaat veranderen, want ook de HES heeft besloten om voor 2030 afscheid te nemen van kolen. Op het terrein zullen andere bulkgoederen komen te liggen, zoals veevoer. Hiermee komt er een einde aan de overslag van steenkool in de Amsterdamse haven.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 5 - Benzolweg (special mobile layout) -->
            <div class="abp-photo-block abp-benzolweg">
                <picture>
                    <source srcset="a-better-port/5.webp" type="image/webp">
                    <img src="a-better-port/5.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Benzolweg</div>
                    <div class="abp-caption-text">Een benzineterminal aan de Benzolweg. Amsterdam is de grootste benzinehaven ter wereld, met meer dan 34 miljoen ton aan olieproducten.</div>
                </div>
            </div>

            <!-- Photo 6 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/6.webp" type="image/webp">
                    <img src="a-better-port/6.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Cor (75)</div>
                    <div class="abp-caption-text">Hoewel hij eigenlijk al 10 jaar met pensioen had moeten zijn, bedient Cor (75 jaar) nog bijna iedere dag de tankwagen. Dat doet hij al sinds zijn allereerste werkdag, op 1 januari 1977. Toen bracht hij nog huisbrandolie rond, later werd dat benzine, diesel en andere brandstoffen. Zojuist heeft Cor 40.000 liter diesel afgeleverd in de Amsterdamse haven.</div>
                </div>
            </div>

            <!-- Infographic Panel after photo 6 -->
            <div class="abp-infographic-panel">
                <!-- Background image with overlay -->
                <div class="abp-infographic-bg">
                    <picture>
                        <source srcset="a-better-port/olietanker.webp" type="image/webp">
                        <img src="a-better-port/olietanker.jpg" alt="">
                    </picture>
                    <div class="abp-infographic-overlay"></div>
                </div>

                <!-- Content -->
                <div class="abp-infographic-content">
                    <div class="abp-infographic-intro">
                        <h2 class="abp-infographic-title">Een haven ter waarde van 4,4 miljard euro</h2>
                        <p>Amsterdam is de grootste benzinehaven ter wereld. Maar wil dat niet blijven. Het aandeel van fossiele brandstoffen wordt langzaam afgebouwd. In plaats daarvan komen duurzame brandstoffen, andere bulkproducten zoals veevoer en graniet.</p>
                    </div>

                    <div class="abp-infographic-chart">
                        <h3 class="abp-chart-title">De Amsterdamse haven in cijfers <span>(2024)</span></h3>

                        <div class="abp-chart-bars">
                            <!-- Olieproducten - 29.1 = 100% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Olieproducten</span>
                                    <span class="abp-bar-change positive">+0,6%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 100%;"></div>
                                </div>
                                <span class="abp-bar-value">29,1 mln ton</span>
                            </div>

                            <!-- Overige droge bulk - 11.5 = 39.5% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Overige droge bulk</span>
                                    <span class="abp-bar-change positive">+5,1%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 39.5%;"></div>
                                </div>
                                <span class="abp-bar-value">11,5 mln ton</span>
                            </div>

                            <!-- Agribulk - 7.1 = 24.4% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Agribulk</span>
                                    <span class="abp-bar-change positive">+12%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 24.4%;"></div>
                                </div>
                                <span class="abp-bar-value">7,1 mln ton</span>
                            </div>

                            <!-- Steenkool - 6.6 = 22.7% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Steenkool</span>
                                    <span class="abp-bar-change negative">-10,9%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill coal" style="--bar-width: 22.7%;"></div>
                                </div>
                                <span class="abp-bar-value">6,6 mln ton</span>
                            </div>

                            <!-- Overige natte bulk - 5.5 = 18.9% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Overige natte bulk</span>
                                    <span class="abp-bar-change negative">-19,2%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 18.9%;"></div>
                                </div>
                                <span class="abp-bar-value">5,5 mln ton</span>
                            </div>

                            <!-- Ro/Ro - 1.6 = 5.5% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Ro/Ro (voertuigen)</span>
                                    <span class="abp-bar-change positive">+1,3%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 5.5%;"></div>
                                </div>
                                <span class="abp-bar-value">1,6 mln ton</span>
                            </div>

                            <!-- Containers - 0.8 = 2.7% -->
                            <div class="abp-bar-item">
                                <div class="abp-bar-label">
                                    <span class="abp-bar-name">Containers</span>
                                    <span class="abp-bar-change negative">-18,2%</span>
                                </div>
                                <div class="abp-bar-track">
                                    <div class="abp-bar-fill" style="--bar-width: 2.7%;"></div>
                                </div>
                                <span class="abp-bar-value">0,8 mln ton</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photo 8 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/8.webp" type="image/webp">
                    <img src="a-better-port/8.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Anton, oliehandelaar</div>
                    <div class="abp-caption-text">Anton is oliehandelaar, met een bescheiden vloot van bunkerschepen. Hij levert zowel diesel als bio-brandstoffen, maar 95% van zijn klanten wil nog gewoon fossiele energie. Hij verwacht niet dat de vraag naar duurzame maar duurdere alternatieven snel zal aantrekken.</div>
                </div>
            </div>

            <!-- Photo 9 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/9.webp" type="image/webp">
                    <img src="a-better-port/9.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Wilco</div>
                    <div class="abp-caption-text">Wilco op weg naar IJmuiden, om een lading steenkoolteer bij Tata op te halen. Koolteer is een restproduct van de productie van kooks en wordt in de haven opgeslagen. Het is een grondstof voor onder andere medische producten.</div>
                </div>
            </div>

            <!-- Photo 10 - Full height -->
            <div class="abp-photo-block size-full">
                <picture>
                    <source srcset="a-better-port/10.webp" type="image/webp">
                    <img src="a-better-port/10.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Petroleumhaven</div>
                    <div class="abp-caption-text">Benzinetanks in de Petroleumhaven. Na de oliecrisis van 1973 hield Nederland lang strategische oliereserves aan, onder andere in de Amsterdamse haven. Met het uitdoven van de koude oorlog ontstond ruimte voor commerciële opslag.</div>
                </div>
            </div>

            <!-- Photo pair 11+12 - Diptych (side by side on mobile) -->
            <div class="abp-photo-pair abp-diptych">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/11.webp" type="image/webp">
                        <img src="a-better-port/11.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Kees-Jan, AEB</div>
                        <div class="abp-caption-text">Kees-Jan bedient de kraan in de bunker van het Afval Energie Bedrijf (AEB), dat afval via verbranding omzet in stroom en warmte voor ongeveer 300.000 huishoudens.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/12.webp" type="image/webp">
                        <img src="a-better-port/12.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Afval Energie Bedrijf</div>
                        <div class="abp-caption-text">Het AEB, met haar iconische schoorstenen, is enerzijds een traditioneel afvalverbrandingsbedrijf, waar gigantische hoeveelheden huisvuil in de oven verdwijnen. Anderzijds wordt het een van de belangrijkste schakels in de circulaire haven van morgen, door meer en meer afval te scheiden waardoor het gerecycled kan worden.</div>
                    </div>
                </div>
            </div>

            <!-- Photo pair 13+14 - Tight pair -->
            <div class="abp-photo-pair abp-tight-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/13.webp" type="image/webp">
                        <img src="a-better-port/13.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Olietanker</div>
                        <div class="abp-caption-text">Uitzicht op het dek van een olietanker. In Amsterdam doen honderden olietankers per jaar de haven aan.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/14.webp" type="image/webp">
                        <img src="a-better-port/14.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Operator</div>
                        <div class="abp-caption-text">Een operator regelt het laden van brandstof. Een nauwkeurig karwei, omdat bij verkeerd laden het schip kan breken. In Amsterdam werd tot voor kort giftige brandstof gemengd en elders ter wereld, meestal Afrika, verkocht. Dat is sinds 2023 verboden.</div>
                    </div>
                </div>
            </div>

            <!-- Photo pair 15+16 -->
            <div class="abp-photo-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/15.webp" type="image/webp">
                        <img src="a-better-port/15.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Zeeman</div>
                        <div class="abp-caption-text">Een zeeman op een olietanker.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/16.webp" type="image/webp">
                        <img src="a-better-port/16.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Kombuis</div>
                        <div class="abp-caption-text">Kombuis van een olietanker. Afhankelijk van het type schip en de rederij zijn zeemannen 6 tot 9 maanden van huis, en leven ze in de kleine ruimtes van het schip.</div>
                    </div>
                </div>
            </div>

            <!-- Text panel + Photo 17 side by side -->
            <div class="abp-text-photo-combo">
                <div class="abp-combo-text">
                    <h3 class="abp-combo-title">9 maanden van huis</h3>
                    <p>Veel zeelieden komen uit de Filipijnen of andere Aziatische landen. Ze werken zo'n 8 à 9 maanden onafgebroken op het schip, en keren dan terug naar huis. Het leven aan boord beschrijven ze als monotoon. Als ze aanmeren in havens is er vaak geen mogelijkheid om de stad in te gaan.</p>
                </div>
                <div class="abp-combo-photo">
                    <div class="abp-combo-photo-wrapper">
                        <picture>
                            <source srcset="a-better-port/17.webp" type="image/webp">
                            <img src="a-better-port/17.jpg" alt="A Better Port" class="photo" loading="lazy">
                        </picture>
                        <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    </div>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Ocean Blue</div>
                        <div class="abp-caption-text">Zeeman op de Ocean Blue, vlak voor aanvang van zijn dienst.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 18 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/18.webp" type="image/webp">
                    <img src="a-better-port/18.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Leon Rasser, havendominee</div>
                    <div class="abp-caption-text">Per fiets bezoekt Leon de zeemannen op de schepen, om met ze te praten, samen te bidden of er simpelweg voor te zorgen dat het internet het doet, zodat het thuisfront gebeld kan worden. Leon komt al jaren op de schepen en kent de haven als geen ander, al blijft hij tegelijkertijd een buitenstaander door de aard van zijn werk. Hij heeft de haven in de loop van tijd zien veranderen, zegt hij, tot de plek die het nu is: een afgesloten plek met de nadruk op hyperefficiëntie. Het heeft het werkplezier en de gemeenschapszin kapot gemaakt. 'Een belangrijke reden om zeevarende te worden is om iets van de wereld te zien. In Amsterdam komt daar meestal weinig van terecht. De werkdruk is te hoog en een substantieel aantal havenbedrijven verbiedt hen overpad naar de openbare weg.' Hij vindt het zijn plicht om de mannen (en een enkele vrouw) te bezoeken.</div>
                </div>
            </div>

            <!-- Photo 20 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/20.webp" type="image/webp">
                    <img src="a-better-port/20.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Michiel, machinist</div>
                    <div class="abp-caption-text">Michiel rijdt een lading volle wagons, gevuld met bio-ethanol, naar het rangeerterrein in de haven. Vanaf daar worden ze verder per spoor vervoerd.</div>
                </div>
            </div>

            <!-- Photo 19 - Full height -->
            <div class="abp-photo-block size-full">
                <picture>
                    <source srcset="a-better-port/19.webp" type="image/webp">
                    <img src="a-better-port/19.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">EVOS terminal</div>
                    <div class="abp-caption-text">Een medewerker van EVOS controleert de brandstoftanks op de terminal. In iedere tank kan zo'n 50 miljoen liter benzine opslaan. De tanks van EVOS zijn klaar voor bio-brandstoffen, maar ze merken dat er geen vraag is vanuit de markt.</div>
                </div>
            </div>

            <!-- Map Interlude - Photo locations -->
            <div class="abp-map-interlude" id="mapInterlude">
            </div>

            <!-- Photo pair 21+22 - Diptych -->
            <div class="abp-photo-pair abp-diptych">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/21.webp" type="image/webp">
                        <img src="a-better-port/21.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Frits, dominee</div>
                        <div class="abp-caption-text">Frits, dominee, leidt een gebed tegen het vertrek van een kolentrein uit de haven. Bijna maandelijks wordt het spoor bezet door tientallen activisten, die de kolentrein soms uren ophouden.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/22.webp" type="image/webp">
                        <img src="a-better-port/22.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Actievoerder</div>
                        <div class="abp-caption-text">Oudere actievoerder op het spoor, met op de achtergrond de kolentrein op de HES terminal. De Amsterdamse politie heeft de actievoerder uiteindelijk van het spoor afgehaald en opgepakt.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 23 - Hemwegcentrale (special mobile layout) -->
            <div class="abp-photo-block abp-benzolweg">
                <picture>
                    <source srcset="a-better-port/23.webp" type="image/webp">
                    <img src="a-better-port/23.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Hemwegcentrale</div>
                    <div class="abp-caption-text">De Hemwegcentrale, de oude kolencentrale die aan 300.000 huishoudens energie leverde, is gesloten en wordt gesloopt. Toen de centrale nog draaide verbrandde het 60 kilo kolen per seconde.</div>
                </div>
            </div>

            <!-- Photo 24 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/24.webp" type="image/webp">
                    <img src="a-better-port/24.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Hemwegcentrale</div>
                    <div class="abp-caption-text">Binnenin de Hemwegcentrale, op de plek waar de oven zat, sloopt een werknemer een van de kolenmaalmolens – het apparaat dat de kolen fijnmaalt tot poedervorm voordat het de oven ingaat.</div>
                </div>
            </div>

            <!-- Sustainability Infographic Panel -->
            <div class="abp-infographic-panel abp-sustainability-panel">
                <!-- Background image with overlay -->
                <div class="abp-infographic-bg">
                    <div class="abp-infographic-overlay"></div>
                </div>

                <!-- Content -->
                <div class="abp-infographic-content">
                    <!-- Titel bovenaan over volle breedte -->
                    <h2 class="abp-infographic-title abp-sustainability-title">Een haven in verandering</h2>

                    <!-- Drie kolommen eronder -->
                    <div class="abp-sustainability-row">
                        <div class="abp-infographic-intro">
                            <p>Er moet veel veranderen in de Amsterdamse haven. Zoals de economie moet verduurzamen, zo moet de haven dat ook. Eruit gaan de fossiele brandstoffen, erin komen nieuwe vormen van energie: waterstof, biobrandstoffen, windmolens en bedrijven die werken aan de circulaire economie, zoals metaalrecycling. In 2050 wil de haven volledig klimaatneutraal zijn.</p>
                        </div>

                    <!-- Main Chart: Transition timeline (groot, bovenaan) -->
                    <div class="abp-transition-chart abp-main-chart">
                            <h4 class="abp-donut-title">Bedrijven in de haven: van fossiel naar duurzaam</h4>
                            <div class="abp-transition-legend">
                                <span class="abp-legend-item sustainable"><span class="abp-legend-dot"></span>Duurzame economie</span>
                                <span class="abp-legend-item fossil"><span class="abp-legend-dot"></span>Fossiele brandstof</span>
                            </div>
                            <div class="abp-transition-bars">
                                <div class="abp-transition-row" data-year="2015">
                                    <span class="abp-transition-year">2015</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 10; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 55; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2016">
                                    <span class="abp-transition-year">2016</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 12; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 55; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2017">
                                    <span class="abp-transition-year">2017</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 15; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 55; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2018">
                                    <span class="abp-transition-year">2018</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 20; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 55; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2019">
                                    <span class="abp-transition-year">2019</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 25; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 50; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2020">
                                    <span class="abp-transition-year">2020</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 30; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 50; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2021">
                                    <span class="abp-transition-year">2021</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 40; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 48; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row crossover" data-year="2022">
                                    <span class="abp-transition-year">2022</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 50; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 45; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2023">
                                    <span class="abp-transition-year">2023</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 65; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 40; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2024">
                                    <span class="abp-transition-year">2024</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 70; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 38; --max: 72;"></div>
                                    </div>
                                </div>
                                <div class="abp-transition-row" data-year="2025">
                                    <span class="abp-transition-year">2025</span>
                                    <div class="abp-transition-bar-container">
                                        <div class="abp-transition-bar sustainable" style="--value: 72; --max: 72;"></div>
                                        <div class="abp-transition-bar fossil" style="--value: 35; --max: 72;"></div>
                                    </div>
                                </div>
                            </div>
                            <p class="abp-transition-source">Bron: Port of Amsterdam jaarverslagen, MyPort bedrijvenlijst</p>
                        </div>

                    <!-- Secondary Charts (kleiner, onderaan) -->
                    <div class="abp-sustainability-charts">
                        <!-- Chart: Alternative fuels storage -->
                        <div class="abp-donut-chart-container">
                            <h4 class="abp-donut-title">Opslagcapaciteit alternatieve brandstoffen</h4>
                            <div class="abp-donut-comparison">
                                <div class="abp-donut-item">
                                    <div class="abp-donut" style="--percentage: 5.4; --color: #6a7d8a;">
                                        <span class="abp-donut-value">5,4%</span>
                                    </div>
                                    <span class="abp-donut-label">2020</span>
                                </div>
                                <div class="abp-donut-arrow">→</div>
                                <div class="abp-donut-item">
                                    <div class="abp-donut" style="--percentage: 10.1; --color: #6a7d8a;">
                                        <span class="abp-donut-value">10,1%</span>
                                    </div>
                                    <span class="abp-donut-label">2024</span>
                                </div>
                            </div>
                        </div>

                        <!-- Chart: Solar panels -->
                        <div class="abp-donut-chart-container">
                            <h4 class="abp-donut-title">Zonnepanelen op haventerreinen</h4>
                            <div class="abp-donut-comparison">
                                <div class="abp-donut-item">
                                    <div class="abp-bar-progress" style="--progress: 74;">
                                        <div class="abp-bar-progress-fill"></div>
                                        <span class="abp-bar-progress-value">260.000 m²</span>
                                    </div>
                                    <span class="abp-donut-label">Huidig</span>
                                </div>
                                <div class="abp-donut-arrow">→</div>
                                <div class="abp-donut-item">
                                    <div class="abp-bar-progress target" style="--progress: 100;">
                                        <div class="abp-bar-progress-fill"></div>
                                        <span class="abp-bar-progress-value">350.000 m²</span>
                                    </div>
                                    <span class="abp-donut-label">Doel 2024</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div><!-- Einde sustainability-row -->
                </div>
            </div>

            <!-- Photo Grid 25-28 (2x2) -->
            <div class="abp-photo-grid-2x2">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/25.webp" type="image/webp">
                        <img src="a-better-port/25.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Biomassacentrale</div>
                        <div class="abp-caption-text">Stoom stijgt op uit de gloednieuwe biomassacentrale, direct naast de oude kolencentrale. Het levert aan 40.000 huishoudens stroom en aan 20.000 huishoudens warmte.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/26.webp" type="image/webp">
                        <img src="a-better-port/26.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Biomassacentrale</div>
                        <div class="abp-caption-text">In de oven werden op het moment van fotograferen de kerstbomen van Amsterdam verbrand.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/27.webp" type="image/webp">
                        <img src="a-better-port/27.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Biomassacentrale</div>
                        <div class="abp-caption-text">Een grijper tilt de houtsnippers van de kerstbomen in de bunker, van waaruit ze naar de oven worden getransporteerd.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/28.webp" type="image/webp">
                        <img src="a-better-port/28.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Bio Energy Netherlands</div>
                        <div class="abp-caption-text">Bij Bio Energy Netherlands worden houtsnippers niet verbrand maar vergast, om er waterstof van te maken. Hier worden de houtsnippers ontdaan van eventuele metaalresten.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 29 - Neo Orbis (special mobile layout) -->
            <div class="abp-photo-block size-full abp-benzolweg">
                <picture>
                    <source srcset="a-better-port/29.webp" type="image/webp">
                    <img src="a-better-port/29.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Neo Orbis</div>
                    <div class="abp-caption-text">De Neo Orbis krijgt haar laatste, marineblauwe verflaag. De nieuwe boot (het zogenaamde representatieschip) van de Port of Amsterdam gaat op waterstof in poedervorm varen, een techniek waarmee havenbedrijf en scheepsbouwer pionieren. De Neo Orbis is daarmee een van de eerste schepen dat op waterstof vaart.</div>
                </div>
            </div>

            <!-- Photo pair 30+31 -->
            <div class="abp-photo-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/30.webp" type="image/webp">
                        <img src="a-better-port/30.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Renewi</div>
                        <div class="abp-caption-text">Bij Renewi rijden vrachtwagens vol sinaasappelresten, groente en fruit dat over datum of rot is, en ander zogenaamd organisch afval, af en aan. Het afval, eenmaal gescheiden van het plastic, gaat in bioreactoren, waar bacteriën het omzetten in gas.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/31.webp" type="image/webp">
                        <img src="a-better-port/31.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Bioreactoren</div>
                        <div class="abp-caption-text">De bioreactoren. Van sinaasappelschil tot gas duurt ongeveer 3 weken.</div>
                    </div>
                </div>
            </div>

            <!-- Photo pair 32+33 - Tight pair (less space between) -->
            <div class="abp-photo-pair abp-tight-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/32.webp" type="image/webp">
                        <img src="a-better-port/32.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Alexa, ingenieur bij Nordsol</div>
                        <div class="abp-caption-text">Alexa, sinds twee jaar werkzaam als ingenieur bij Nordsol. Nordsol verandert het biogas uit de reactoren in bio-LNG, een brandstof voor schepen en vrachtwagens. 'Al sinds mijn studie werktuigbouwkunde besef ik dat je op individueel niveau iets zinvols kan bijdragen. Ik heb daarom bewust gekozen om mijn passie voor technische onderwerpen in te zetten voor milieu- en klimaatkwesties.'</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/33.webp" type="image/webp">
                        <img src="a-better-port/33.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Nordsol, bio-LNG</div>
                        <div class="abp-caption-text">Zoals veel duurzame technieken, staat ook de productie van bio-LNG nog in de kinderschoenen. De huidige installatie kan drie keer per week een tankwagen vullen, een kleine hoeveelheid vergeleken met de continue af- en aanvoer van fossiele brandstoffen. Maar Nordsol is deze techniek snel aan het uitrollen.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 34 - Schrootmetalen (special mobile layout) -->
            <div class="abp-photo-block size-full abp-benzolweg">
                <picture>
                    <source srcset="a-better-port/34.webp" type="image/webp">
                    <img src="a-better-port/34.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Schrootmetalen terminal</div>
                    <div class="abp-caption-text">Tot vorig jaar lagen hier kolen, maar nu worden schrootmetalen in de zeeschepen geladen. Vanaf daar gaat het de wereld over om gerecycled te worden.</div>
                </div>
            </div>

            <!-- Photo 35 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/35.webp" type="image/webp">
                    <img src="a-better-port/35.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Schrootmetalen</div>
                    <div class="abp-caption-text">Het laden van schroot.</div>
                </div>
            </div>

            <!-- Photo 36 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/36.webp" type="image/webp">
                    <img src="a-better-port/36.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Windmolenbladen</div>
                    <div class="abp-caption-text">Drie windmolenbladen van meer dan 80 meter lang worden klaargemaakt voor transport naar het IJsselmeer, waar gigantische kranen ze aan de turbine zullen bevestigen. In Nederland worden nog steeds veel nieuwe windparken ontwikkeld, waar steeds grotere windturbines worden geplaatst. Op plekken als de haven van IJmuiden en de haven van Amsterdam worden de onderdelen van de parken verzameld en vervoerd.</div>
                </div>
            </div>

            <!-- Photo 37 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/37.webp" type="image/webp">
                    <img src="a-better-port/37.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Lucy</div>
                    <div class="abp-caption-text">Lucy pleegt onderhoud aan een bunkerboot.</div>
                </div>
            </div>

            <!-- Photo pair 38+39 -->
            <div class="abp-photo-pair">
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/38.webp" type="image/webp">
                        <img src="a-better-port/38.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Plastic Recycle Fabriek</div>
                        <div class="abp-caption-text">Medewerkers sorteren plastic in de Plastic Recycle Fabriek in de haven.</div>
                    </div>
                </div>
                <div class="abp-photo-block">
                    <picture>
                        <source srcset="a-better-port/39.webp" type="image/webp">
                        <img src="a-better-port/39.jpg" alt="A Better Port" class="photo" loading="lazy">
                    </picture>
                    <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                    <div class="abp-caption">
                        <div class="abp-caption-header">Plastic Recycle Fabriek</div>
                        <div class="abp-caption-text">Sinds de foto's gemaakt zijn, is de fabriek failliet gegaan. Ze konden niet op tegen de vloedgolf van goedkoop, nieuw plastic dat de wereld momenteel overspoelt. Gerecycled plastic kan voorlopig alleen bestaan als de overheid het verplicht stelt – iets wat in de toekomst overigens gaat gebeuren.</div>
                    </div>
                </div>
            </div>

            <!-- Photo 40 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/40.webp" type="image/webp">
                    <img src="a-better-port/40.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Argent Energy</div>
                    <div class="abp-caption-text">Gebruikt frituurvet wordt gelost uit een tankwagen. Bij Argent Energy, veruit de grootste bio-brandstofproducent van de haven, wordt frituurvet omgetoverd tot bio-diesel.</div>
                </div>
            </div>

            <!-- Photo 41 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/41.webp" type="image/webp">
                    <img src="a-better-port/41.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Marie Antony, Argent Energy</div>
                    <div class="abp-caption-text">Marie Antony aan het werk in het lab van Argent Energy. Hij controleert samples frituurvet en dierlijk vet op hun zuiverheidsgraad.</div>
                </div>
            </div>

            <!-- Photo 42 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/42.webp" type="image/webp">
                    <img src="a-better-port/42.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Distributiecentrum van de toekomst</div>
                    <div class="abp-caption-text">Het 'distributiecentrum van de toekomst', een CO2-neutraal complex, inclusief aanlegsteiger voor boten die de stad per water kunnen bevoorraden. Voorlopig staan de meeste hallen nog leeg.</div>
                </div>
            </div>

            <!-- Photo 43 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/43.webp" type="image/webp">
                    <img src="a-better-port/43.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Kolentrein</div>
                    <div class="abp-caption-text">Een kolentrein rijdt door de haven.</div>
                </div>
            </div>

            <!-- Photo 44 -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/44.webp" type="image/webp">
                    <img src="a-better-port/44.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Bato, rangeerder</div>
                    <div class="abp-caption-text">Bij het vallen van de avond maakt hij een lading ethanol klaar voor vertrek.</div>
                </div>
            </div>

            <!-- Photo 45 - EVOS terminal nacht (special mobile layout) -->
            <div class="abp-photo-block size-full abp-benzolweg">
                <picture>
                    <source srcset="a-better-port/45.webp" type="image/webp">
                    <img src="a-better-port/45.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">EVOS terminal</div>
                    <div class="abp-caption-text">Binnenvaartschepen wachten totdat ze bij EVOS brandstof kunnen inladen. Het vervoer van benzine, diesel en andere brandstoffen gaat dag en nacht door.</div>
                </div>
            </div>

            <!-- Photo 46 - Last -->
            <div class="abp-photo-block">
                <picture>
                    <source srcset="a-better-port/46.webp" type="image/webp">
                    <img src="a-better-port/46.jpg" alt="A Better Port" class="photo" loading="lazy">
                </picture>
                <button class="abp-info-btn" aria-label="Toon informatie">i</button>
                <div class="abp-caption">
                    <div class="abp-caption-header">Virginia Holt, Young Board</div>
                    <div class="abp-caption-text">Virginia Holt vormt samen met 4 anderen de Young Board van de Port of Amsterdam. Zij beoordelen beleid van de directie op de impact op volgende generaties. Ze maakt zich enorm zorgen over de toekomst, maar ziet ook dat de haven de plek is op bij te dragen aan een duurzamere samenleving. 'Als internationale zeehaven spelen we een centrale rol in de energietransitie. Hoewel de uitdagingen enorm zijn blijf ik toch optimistisch: "It always seems impossible until it's done"'</div>
                </div>
            </div>

            <div class="end-panel" style="flex-shrink: 0; height: 100vh; width: 33vw; max-width: 600px; min-width: 300px; background: #1e3a4f; display: flex; flex-direction: column; justify-content: center; padding: 3rem;">
                <p style="font-family: 'Scala Sans SC', sans-serif; font-size: 1.2rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 3rem;">Einde van deze serie</p>
                <p style="font-family: 'Scala Sans', sans-serif; font-size: 0.85rem; color: rgba(255,255,255,0.4); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Bekijk ook</p>
                <nav style="display: flex; flex-direction: column; gap: 0.6rem;">
                    <a href="/" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">Home</a>
                    <a href="de-exoten.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">De Exoten</a>
                    <a href="mijn-tatoeages.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">Mijn Tatoeages</a>
                    <a href="in-blauw-licht.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">In Blauw Licht</a>
                    <a href="toen-de-mijnen-verdwenen.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">Toen de Mijnen Verdwenen</a>
                    <a href="het-noordzeekanaal-gebied.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">Het Noordzeekanaalgebied</a>
                    <a href="de-onmisbaren.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">De Onmisbaren</a>
                    <a href="een-plek-onder-de-zon.html" style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; text-decoration: none; transition: color 0.3s;">Een Plek Onder de Zon</a>
                </nav>
                <div style="margin-top: 3rem;">
                    <p style="font-family: 'Scala Sans', sans-serif; font-size: 0.85rem; color: rgba(255,255,255,0.4); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Contact</p>
                    <p style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; margin-bottom: 0.3rem;">wouterzaalberg@gmail.com</p>
                    <p style="font-family: 'Scala Sans', sans-serif; font-size: 0.95rem; color: #ffffff; margin-bottom: 1.5rem;">06 45 788 180</p>
                    <a href="https://instagram.com/wouterzaalberg" target="_blank" style="display: inline-block; color: #ffffff; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const container = document.getElementById('scrollContainer');
        const introSection = document.getElementById('introSection');
        const allItems = document.querySelectorAll('.abp-intro-section, .abp-photo-block:not(.abp-photo-pair .abp-photo-block):not(.abp-combo-photo .abp-photo-block):not(.abp-photo-set .abp-photo-block):not(.abp-photo-grid-2x2 .abp-photo-block), .abp-photo-pair, .abp-photo-grid-2x2, .abp-infographic-panel, .abp-text-photo-combo, .abp-photo-set, .abp-quote-panel, .abp-map-interlude, .end-panel');
        const infoButtons = document.querySelectorAll('.abp-info-btn');
        const quotePanels = document.querySelectorAll('.abp-quote-panel');
        let currentIndex = 0;
        let isAnimating = false;
        let introState = 0; // 0 = text panel, 1 = photo 1, 2 = photo 2

        // Prevent middle-click autoscroll (browser's drag-to-scroll feature)
        container.addEventListener('mousedown', (e) => {
            if (e.button === 1) { // Middle mouse button
                e.preventDefault();
            }
        });

        // Improved scroll handling - works for both mouse and trackpad
        // See docs/horizontal-scroll.md for documentation
        let accumulatedDelta = 0;
        let lastDelta = 0;
        let scrollDirection = 0;
        let lastScrollTime = 0;
        const DELTA_THRESHOLD = 50;  // Minimum delta to trigger scroll
        const COOLDOWN = 500;        // Ms to wait after scroll (trackpad)
        const COOLDOWN_FAST = 150;   // Ms to wait after mouse wheel scroll
        const MOMENTUM_THRESHOLD = 0.5; // Ignore if delta drops below this ratio
        const MOUSE_WHEEL_DELTA = 80;   // Typical mouse wheel delta
        const SCROLL_PAUSE = 150;       // Ms pause indicates new scroll action

        // Info button toggle
        infoButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const photoBlock = btn.closest('.abp-photo-block') || btn.closest('.abp-intro-photo') || btn.closest('.abp-intro-photo2') || btn.closest('.abp-mobile-photo1-img') || btn.closest('.abp-mobile-photo2-img');

                // Close other open captions
                document.querySelectorAll('.abp-photo-block.info-active, .abp-intro-photo.info-active, .abp-intro-photo2.info-active, .abp-mobile-photo1-img.info-active, .abp-mobile-photo2-img.info-active').forEach(block => {
                    if (block !== photoBlock) {
                        block.classList.remove('info-active');
                    }
                });

                // Toggle current
                if (photoBlock) {
                    photoBlock.classList.toggle('info-active');
                }
            });
        });

        // Close caption when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.abp-photo-block') && !e.target.closest('.abp-intro-photo') && !e.target.closest('.abp-intro-photo2') && !e.target.closest('.abp-combo-photo') && !e.target.closest('.abp-grid-item') && !e.target.closest('.abp-stack-item') && !e.target.closest('.abp-mobile-photo1-img') && !e.target.closest('.abp-mobile-photo2-img')) {
                document.querySelectorAll('.abp-photo-block.info-active, .abp-intro-photo.info-active, .abp-intro-photo2.info-active, .abp-combo-photo.info-active, .abp-grid-item.info-active, .abp-stack-item.info-active, .abp-mobile-photo1-img.info-active, .abp-mobile-photo2-img.info-active').forEach(block => {
                    block.classList.remove('info-active');
                });
            }
        });

        // Quote panel reveal effect using Intersection Observer
        const quoteObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('revealed');
                }
            });
        }, {
            root: container,
            rootMargin: '0px',
            threshold: 0.3
        });

        quotePanels.forEach(panel => {
            quoteObserver.observe(panel);
        });

        // Combo section: text fade + photo zoom using Intersection Observer
        const comboPhoto = document.querySelector('.abp-combo-photo-wrapper img');
        const comboPhotoContainer = document.querySelector('.abp-text-photo-combo');

        if (comboPhoto && comboPhotoContainer) {
            const comboObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                        comboPhoto.classList.add('zoomed');
                    }
                });
            }, {
                root: container,
                rootMargin: '0px',
                threshold: 0.3
            });

            comboObserver.observe(comboPhotoContainer);
        }

        // Infographic panels fade-in animation
        const infographicPanels = document.querySelectorAll('.abp-infographic-panel');
        if (infographicPanels.length > 0) {
            const infographicObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                    }
                });
            }, {
                root: container,
                rootMargin: '0px',
                threshold: 0.3
            });

            infographicPanels.forEach(panel => {
                infographicObserver.observe(panel);
            });
        }

        // Combo photo info button functionality
        const comboPhotoBlock = document.querySelector('.abp-combo-photo');
        if (comboPhotoBlock) {
            const comboInfoBtn = comboPhotoBlock.querySelector('.abp-info-btn');
            if (comboInfoBtn) {
                comboInfoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other captions
                    document.querySelectorAll('.abp-photo-block.info-active, .abp-intro-photo.info-active, .abp-intro-photo2.info-active, .abp-combo-photo.info-active, .abp-grid-item.info-active').forEach(block => {
                        if (block !== comboPhotoBlock) {
                            block.classList.remove('info-active');
                        }
                    });
                    comboPhotoBlock.classList.toggle('info-active');
                });
            }
        }

        // Grid item info button functionality
        const gridItems = document.querySelectorAll('.abp-grid-item');
        gridItems.forEach(gridItem => {
            const infoBtn = gridItem.querySelector('.abp-info-btn');
            if (infoBtn) {
                infoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other captions
                    document.querySelectorAll('.abp-photo-block.info-active, .abp-intro-photo.info-active, .abp-intro-photo2.info-active, .abp-combo-photo.info-active, .abp-grid-item.info-active').forEach(block => {
                        if (block !== gridItem) {
                            block.classList.remove('info-active');
                        }
                    });
                    gridItem.classList.toggle('info-active');
                });
            }
        });

        // Stack item info button functionality (for photo set 25-28)
        const stackItems = document.querySelectorAll('.abp-stack-item');
        stackItems.forEach(stackItem => {
            const infoBtn = stackItem.querySelector('.abp-info-btn');
            if (infoBtn) {
                infoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other captions
                    document.querySelectorAll('.abp-photo-block.info-active, .abp-intro-photo.info-active, .abp-intro-photo2.info-active, .abp-combo-photo.info-active, .abp-grid-item.info-active, .abp-stack-item.info-active').forEach(block => {
                        if (block !== stackItem) {
                            block.classList.remove('info-active');
                        }
                    });
                    stackItem.classList.toggle('info-active');
                });
            }
        });

        // Toggle intro section between states: 0 = text panel, 1 = photo 1, 2 = photo 2
        function setIntroState(state) {
            introState = state;
            introSection.classList.remove('show-photo1', 'show-photo2');

            if (state === 1) {
                introSection.classList.add('show-photo1');
            } else if (state === 2) {
                introSection.classList.add('show-photo2');
            }
            // state === 0: no class needed, text panel visible by default
        }

        // Check if at intro section
        function isAtIntroSection(index) {
            return allItems[index] === introSection;
        }

        // Scroll to target index
        function scrollToIndex(index) {
            if (index < 0) index = 0;
            if (index >= allItems.length) index = allItems.length - 1;

            currentIndex = index;

            allItems[currentIndex].scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'center'
            });
        }

        // Process scroll with intro section logic (3 states)
        function handleScroll(direction) {
            // direction: 1 = forward, -1 = backward

            // If at intro section
            if (isAtIntroSection(currentIndex)) {
                if (direction > 0) {
                    // Forward: text → photo 1 → photo 2 → next
                    if (introState === 0) {
                        setIntroState(1);
                        return;
                    } else if (introState === 1) {
                        setIntroState(2);
                        return;
                    }
                    // introState === 2: continue to next item
                } else if (direction < 0) {
                    // Backward: photo 2 → photo 1 → text → prev
                    if (introState === 2) {
                        setIntroState(1);
                        return;
                    } else if (introState === 1) {
                        setIntroState(0);
                        return;
                    }
                    // introState === 0: continue to previous item (if any)
                }
            }

            // Normal scrolling
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < allItems.length) {
                scrollToIndex(newIndex);
                // Reset intro state when coming back to intro section
                if (isAtIntroSection(newIndex) && direction < 0) {
                    setIntroState(2); // Coming back from next item, show photo 2
                }
            }
        }

        // Trigger scroll in direction (optional fast cooldown for mouse wheel)
        function triggerScroll(direction, fast = false) {
            if (isAnimating) return;
            isAnimating = true;
            handleScroll(direction);
            setTimeout(() => {
                isAnimating = false;
                accumulatedDelta = 0;
                lastDelta = 0;
                scrollDirection = 0;
            }, fast ? COOLDOWN_FAST : COOLDOWN);
        }

        // Keyboard navigation (arrow keys)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                e.preventDefault();
                triggerScroll(1);
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                e.preventDefault();
                triggerScroll(-1);
            }
        });

        // Smooth scroll handling (desktop only)
        if (window.innerWidth > 767) {
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = Math.abs(e.deltaY);
                const direction = e.deltaY > 0 ? 1 : -1;
                const now = Date.now();
                const timeSinceLastScroll = now - lastScrollTime;
                lastScrollTime = now;

                if (isAnimating) return;

                // Detect mouse wheel: large delta after a pause
                if (timeSinceLastScroll > SCROLL_PAUSE && delta >= MOUSE_WHEEL_DELTA) {
                    triggerScroll(direction, true); // fast cooldown for mouse wheel
                    accumulatedDelta = 0;
                    lastDelta = 0;
                    return;
                }

                // Reset after pause (new scroll action)
                if (timeSinceLastScroll > SCROLL_PAUSE) {
                    lastDelta = 0;
                    accumulatedDelta = 0;
                }

                // Momentum detection: ignore decreasing deltas (trackpad coasting)
                if (lastDelta > 0 && delta < lastDelta * MOMENTUM_THRESHOLD) {
                    lastDelta = delta;
                    return;
                }

                // Reset if direction changes
                if (scrollDirection !== 0 && direction !== scrollDirection) {
                    accumulatedDelta = 0;
                }

                scrollDirection = direction;
                accumulatedDelta += delta;
                lastDelta = delta;

                // Trigger scroll when threshold reached
                if (accumulatedDelta >= DELTA_THRESHOLD) {
                    triggerScroll(direction);
                }
            }, { passive: false });
        }

        // Fade in images when loaded and position buttons/captions
        const images = document.querySelectorAll('.abp-photo-block img.photo, .abp-hero-image img, .abp-grid-item img.photo, .abp-stack-item img.photo');

        function positionPhotoElements(img) {
            const photoBlock = img.closest('.abp-photo-block');
            if (!photoBlock) return;

            const infoBtn = photoBlock.querySelector('.abp-info-btn');
            const caption = photoBlock.querySelector('.abp-caption');
            const photoRect = img.getBoundingClientRect();
            const blockRect = photoBlock.getBoundingClientRect();

            // Calculate photo position within block
            const photoBottom = blockRect.bottom - photoRect.bottom;
            const photoRight = blockRect.right - photoRect.right;

            // Position info button inside photo (1rem from bottom-right)
            if (infoBtn) {
                infoBtn.style.bottom = (photoBottom + 16) + 'px'; // 1rem = 16px
                infoBtn.style.right = (photoRight + 16) + 'px';
            }

            // Position caption with same width as photo, bottom aligned with photo bottom
            if (caption) {
                const photoLeft = photoRect.left - blockRect.left;
                caption.style.left = photoLeft + 'px';
                caption.style.width = photoRect.width + 'px';
                caption.style.right = 'auto';
                caption.style.bottom = photoBottom + 'px'; // Onderkant caption gelijk aan onderkant foto
            }
        }

        images.forEach(img => {
            if (img.complete) {
                img.classList.add('loaded');
                positionPhotoElements(img);
            } else {
                img.addEventListener('load', () => {
                    img.classList.add('loaded');
                    positionPhotoElements(img);
                });
            }
        });

        // Reposition on resize
        window.addEventListener('resize', () => {
            images.forEach(img => {
                if (img.complete) {
                    positionPhotoElements(img);
                }
            });
        });

        // Sync intro panel width and title positions with photo 1
        function syncIntroLayout() {
            // First intro section - use wrapper for dimensions (stable, no zoom scaling)
            const introPhotoWrapper = document.querySelector('#introSection .abp-intro-photo-wrapper');
            const introPhoto = document.querySelector('#introSection .abp-intro-photo img');
            const introContent = document.querySelector('#introSection .abp-intro-content');
            const introTitle = document.getElementById('introTitle');
            const introInfoBtn = document.querySelector('#introSection .abp-intro-photo .abp-info-btn');
            const introCaption = document.querySelector('#introSection .abp-intro-photo .abp-caption');

            // Photo 2 elements
            const photo2Wrapper = document.querySelector('#introSection .abp-intro-photo2 .abp-intro-photo-wrapper');
            const photo2Img = document.querySelector('#introSection .abp-intro-photo2 img');
            const photo2InfoBtn = document.querySelector('#introSection .abp-intro-photo2 .abp-info-btn');
            const photo2Caption = document.querySelector('#introSection .abp-intro-photo2 .abp-caption');

            if (introPhoto && introPhoto.complete && introPhotoWrapper) {
                const wrapperRect = introPhotoWrapper.getBoundingClientRect();
                const photoWidth = wrapperRect.width;
                const photoLeft = wrapperRect.left;
                const photoRight = wrapperRect.right;
                const viewportWidth = window.innerWidth;

                // Tekstkader zelfde breedte als foto
                if (introContent) {
                    introContent.style.maxWidth = photoWidth + 'px';
                    introContent.style.width = photoWidth + 'px';
                }

                // Titel positioneren LINKS van de foto (rechts uitgelijnd)
                // De rechterrand van de titel zit tegen de linkerrand van de foto met een kleine gap
                if (introTitle) {
                    const gap = 40; // 2.5rem gap tussen titel en foto
                    const titleRight = viewportWidth - photoLeft + gap;
                    introTitle.style.right = titleRight + 'px';
                    introTitle.style.left = 'auto';
                }

                // Info button rechtsonder naast de foto
                if (introInfoBtn) {
                    introInfoBtn.style.left = (photoRight - 40) + 'px';
                }

                // Caption onder de foto, zelfde breedte
                if (introCaption) {
                    introCaption.style.width = photoWidth + 'px';
                }
            }

            // Position photo 2 elements
            if (photo2Img && photo2Img.complete && photo2Wrapper) {
                const wrapper2Rect = photo2Wrapper.getBoundingClientRect();
                const introRect = introSection.getBoundingClientRect();
                const photo2Width = wrapper2Rect.width;
                const photo2Left = wrapper2Rect.left - introRect.left;
                const photo2Bottom = introRect.bottom - wrapper2Rect.bottom;
                const photo2Right = introRect.right - wrapper2Rect.right;

                // Info button rechtsonder in de foto
                if (photo2InfoBtn) {
                    photo2InfoBtn.style.bottom = (photo2Bottom + 16) + 'px';
                    photo2InfoBtn.style.right = (photo2Right + 16) + 'px';
                    photo2InfoBtn.style.left = 'auto';
                }

                // Caption zelfde breedte als foto, onderkant gelijk aan onderkant foto
                if (photo2Caption) {
                    photo2Caption.style.left = photo2Left + 'px';
                    photo2Caption.style.width = photo2Width + 'px';
                    photo2Caption.style.bottom = photo2Bottom + 'px';
                    photo2Caption.style.right = 'auto';
                    photo2Caption.style.transform = 'none';
                }
            }
        }

        // Dark overlay control based on current photo index
        const darkOverlay = document.getElementById('darkOverlay');

        function updateDarkOverlay() {
            let opacity = 0;
            let bgOpacity = 0.8;

            // Photo 1-2: heel donker (0.9)
            // Photo 3-19: gradually lighter (0.9 -> 0)
            // Photo 19-40: light (0)
            // Photo 41-46: gradually darker (0 -> 0.9) - helemaal donker
            // Photo 46+: maintain at 0.9

            const photoNum = getApproximatePhotoNumber(currentIndex);

            if (photoNum <= 2) {
                opacity = 0.9;
                bgOpacity = 0.9;
            } else if (photoNum <= 19) {
                // Geleidelijk van 0.9 naar 0 over foto's 3-19 (17 foto's)
                const progress = (photoNum - 2) / 17;
                opacity = 0.9 * (1 - progress);
                bgOpacity = 0.9 * (1 - progress);
            } else if (photoNum <= 40) {
                opacity = 0;
                bgOpacity = 0;
            } else if (photoNum <= 46) {
                // Foto 41-46: geleidelijk naar helemaal donker (0.9)
                const progress = (photoNum - 40) / 6;
                opacity = 0.9 * progress;
                bgOpacity = 0.9 * progress;
            } else {
                opacity = 0.9;
                bgOpacity = 0.9;
            }

            if (darkOverlay) {
                darkOverlay.style.opacity = opacity;
            }

            // Update CSS variable voor photo block backgrounds
            document.documentElement.style.setProperty('--photo-bg-opacity', bgOpacity);
        }

        // Helper to map scroll index to photo number
        // Exacte mapping van scroll index naar fotonummer
        function getApproximatePhotoNumber(index) {
            const mapping = [
                2,   // 0: intro section (photo 1-2)
                4,   // 1: photo pair 3+4
                5,   // 2: photo 5
                6,   // 3: photo 6
                7,   // 4: infographic panel 1
                8,   // 5: photo 8
                9,   // 6: photo 9
                10,  // 7: photo 10
                12,  // 8: photo pair 11+12
                14,  // 9: photo pair 13+14
                16,  // 10: photo pair 15+16
                17,  // 11: text-photo-combo (photo 17)
                18,  // 12: photo 18
                20,  // 13: photo 20
                19,  // 14: photo 19
                20,  // 15: map interlude (between photo 19 and 21)
                22,  // 16: photo pair 21+22
                23,  // 17: photo 23
                24,  // 18: photo 24
                24,  // 19: sustainability panel
                28,  // 20: photo set 25-28
                29,  // 21: photo 29
                31,  // 22: photo pair 30+31
                33,  // 23: photo pair 32+33
                34,  // 24: photo 34
                35,  // 25: photo 35
                36,  // 26: photo 36
                37,  // 27: photo 37
                39,  // 28: photo pair 38+39
                40,  // 29: photo 40
                41,  // 30: photo 41
                42,  // 31: photo 42
                43,  // 32: photo 43
                44,  // 33: photo 44
                45,  // 34: photo 45
                46,  // 35: photo 46
                47   // 36: end-panel
            ];
            if (index < mapping.length) {
                return mapping[index];
            }
            return 47; // Na einde
        }

        // Update overlay on scroll
        const originalScrollToIndex = scrollToIndex;
        scrollToIndex = function(index) {
            originalScrollToIndex(index);
            updateDarkOverlay();
            updateYellowPanelsFade(index);
        };

        // Fade out yellow panels when scrolled past them
        const textPhotoCombo = document.querySelector('.abp-text-photo-combo');
        const infographicPanelFirst = document.querySelector('.abp-infographic-panel:not(.abp-sustainability-panel)');
        const sustainabilityPanel = document.querySelector('.abp-sustainability-panel');

        function updateYellowPanelsFade(index) {
            // First infographic panel ("4,4 miljard") is at allItems index 4, fade when past it (index > 4)
            if (infographicPanelFirst) {
                if (index > 4) {
                    infographicPanelFirst.classList.add('faded-out');
                } else {
                    infographicPanelFirst.classList.remove('faded-out');
                }
            }

            // text-photo-combo is at allItems index 11, fade when past it (index > 11)
            if (textPhotoCombo) {
                if (index > 11) {
                    textPhotoCombo.classList.add('faded-out');
                } else {
                    textPhotoCombo.classList.remove('faded-out');
                }
            }

            // sustainability panel is at allItems index 19, fade when past it (index > 19)
            if (sustainabilityPanel) {
                if (index > 19) {
                    sustainabilityPanel.classList.add('faded-out');
                } else {
                    sustainabilityPanel.classList.remove('faded-out');
                }
            }
        }

        // Initial update
        updateDarkOverlay();
        updateYellowPanelsFade(currentIndex);

        // Run on load and resize
        const introPhotos = document.querySelectorAll('.abp-intro-photo img, .abp-intro-photo2 img');
        introPhotos.forEach(img => {
            if (img.complete) {
                syncIntroLayout();
            } else {
                img.addEventListener('load', syncIntroLayout);
            }
        });
        window.addEventListener('resize', syncIntroLayout);

        // ========================================
        // Leaflet Map Background + Ship Animation
        // ========================================

        // Initialize harbor map with Leaflet
        const harborMap = L.map('harborMap', {
            zoomControl: false,
            attributionControl: false,
            scrollWheelZoom: false,
            dragging: false,
            doubleClickZoom: false,
            touchZoom: false,
            keyboard: false
        }).setView([window.innerWidth <= 767 ? 52.39 : 52.410, window.innerWidth <= 767 ? 4.80 : 4.78], window.innerWidth <= 767 ? 12.5 : 14); // Port of Amsterdam - shifted south+west on mobile, slightly zoomed out

        // CartoDB dark tiles (made darker via CSS filter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(harborMap);

        // Ensure map renders correctly
        setTimeout(() => harborMap.invalidateSize(), 100);
        console.log('Harbor map initialized');

        // Ship Animation on Canvas overlay
        (function() {
            const canvas = document.getElementById('shipCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Resize canvas to match viewport
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', () => {
                resizeCanvas();
                harborMap.invalidateSize();
            });

            // Ship class using lat/lng coordinates
            // Route connection map - defines where routes connect to each other
            // Routes: 0=Rood, 1=Groen, 2=Blauw, 3=Geel, 4=Roze, 5=Turquoise, 6=Oranje, 7=NieuweLijn, 8=Limegroen, 9=IJ, 10=PaarsRoze, 11=IJbasin
            const routeConnections = {
                // Route 0 (Noordzeekanaal) connects to harbor routes at various points
                0: [
                    { target: 1, atProgress: 0.22, targetProgress: 0 }, // to green harbor
                    { target: 2, atProgress: 0.30, targetProgress: 0 }, // to blue harbor
                    { target: 5, atProgress: 0.45, targetProgress: 0 }, // to turquoise
                    { target: 8, atProgress: 0.52, targetProgress: 0 }, // to lime green
                    { target: 9, atProgress: 0.65, targetProgress: 0 }, // to IJ waterway
                ],
                // Harbor routes connect back to route 0 and to side routes
                1: [{ target: 0, atProgress: 0, targetProgress: 0.22 }],
                2: [{ target: 0, atProgress: 0, targetProgress: 0.30 }, { target: 3, atProgress: 0.7, targetProgress: 0 }, { target: 4, atProgress: 1, targetProgress: 0 }],
                3: [{ target: 2, atProgress: 0, targetProgress: 0.7 }],
                4: [{ target: 2, atProgress: 0, targetProgress: 1 }],
                5: [{ target: 0, atProgress: 0, targetProgress: 0.45 }, { target: 6, atProgress: 0.5, targetProgress: 0 }, { target: 7, atProgress: 0.6, targetProgress: 0 }],
                6: [{ target: 5, atProgress: 0, targetProgress: 0.5 }],
                7: [{ target: 5, atProgress: 0, targetProgress: 0.6 }],
                8: [{ target: 0, atProgress: 0, targetProgress: 0.52 }],
                9: [{ target: 0, atProgress: 0, targetProgress: 0.65 }, { target: 10, atProgress: 0.4, targetProgress: 0 }, { target: 11, atProgress: 0.7, targetProgress: 0 }],
                10: [{ target: 9, atProgress: 0, targetProgress: 0.4 }],
                11: [{ target: 9, atProgress: 0, targetProgress: 0.7 }],
            };

            // Destination harbors (end points where ships dock)
            const destinationRoutes = [1, 3, 4, 6, 7, 8, 10, 11];

            class Ship {
                constructor(speed, size) {
                    this.speed = speed;
                    this.size = size;

                    // Start on route 0 (Noordzeekanaal) coming from the sea
                    this.routeIndex = 0;
                    this.route = routes[0];
                    this.progress = 0; // Start at sea (left)
                    this.direction = 1; // Moving into harbor

                    // Pick a random destination harbor
                    this.destinationRoute = destinationRoutes[Math.floor(Math.random() * destinationRoutes.length)];
                    this.headingToSea = false; // true when returning to sea after docking

                    this.dockingTime = 0;
                    this.transitionCooldown = 0; // Prevent immediate re-transition
                }

                // Find path to target route using BFS
                findPathTo(target) {
                    if (this.routeIndex === target) return [];

                    const visited = new Set([this.routeIndex]);
                    const queue = [[this.routeIndex, []]];

                    while (queue.length > 0) {
                        const [current, path] = queue.shift();
                        const connections = routeConnections[current] || [];

                        for (const conn of connections) {
                            if (conn.target === target) {
                                return [...path, { from: current, conn }];
                            }
                            if (!visited.has(conn.target)) {
                                visited.add(conn.target);
                                queue.push([conn.target, [...path, { from: current, conn }]]);
                            }
                        }
                    }
                    return null; // No path found
                }

                // Find the connection point to get closer to destination
                findNextTransition() {
                    const targetRoute = this.headingToSea ? 0 : this.destinationRoute;
                    if (this.routeIndex === targetRoute) return null;

                    const path = this.findPathTo(targetRoute);
                    if (!path || path.length === 0) return null;

                    // Return the first step in the path
                    return path[0].conn;
                }

                update(allShips) {
                    // Decrease transition cooldown
                    if (this.transitionCooldown > 0) this.transitionCooldown--;

                    // Check if ship is docking
                    if (this.dockingTime > 0) {
                        this.dockingTime--;
                        return;
                    }

                    // Check for collision with ships ahead on same route (keep minimal distance)
                    const minDistance = 0.05;
                    for (const other of allShips) {
                        if (other === this || other.routeIndex !== this.routeIndex) continue;
                        const diff = other.progress - this.progress;
                        if (this.direction > 0 && diff > 0 && diff < minDistance) {
                            // Slow down instead of stopping completely
                            this.progress += this.speed * 0.3 * this.direction;
                            return;
                        }
                        if (this.direction < 0 && diff < 0 && diff > -minDistance) {
                            this.progress += this.speed * 0.3 * this.direction;
                            return;
                        }
                    }

                    // Determine where ship needs to go next
                    const nextTransition = this.findNextTransition();

                    // Check for route transition
                    if (nextTransition && this.transitionCooldown === 0) {
                        const distToTransition = Math.abs(this.progress - nextTransition.atProgress);
                        if (distToTransition < 0.03) {
                            // Transition to new route
                            this.routeIndex = nextTransition.target;
                            this.route = routes[nextTransition.target];
                            this.progress = nextTransition.targetProgress;

                            // Determine new direction based on next goal
                            const newTransition = this.findNextTransition();
                            if (newTransition) {
                                this.direction = newTransition.atProgress > this.progress ? 1 : -1;
                            } else if (this.routeIndex === this.destinationRoute && !this.headingToSea) {
                                // At destination, go towards end to dock
                                this.direction = 1;
                            } else if (this.headingToSea) {
                                // Heading to sea on route 0
                                this.direction = -1;
                            }

                            this.transitionCooldown = 60;
                            return;
                        }

                        // Adjust direction to reach transition point
                        if (nextTransition.atProgress > this.progress && this.direction < 0) {
                            this.direction = 1;
                        } else if (nextTransition.atProgress < this.progress && this.direction > 0) {
                            this.direction = -1;
                        }
                    }

                    // Move ship
                    this.progress += this.speed * this.direction;

                    // Handle route endpoints
                    if (this.progress >= 1) {
                        this.progress = 1;

                        if (this.routeIndex === this.destinationRoute && !this.headingToSea) {
                            // Arrived at destination - dock and prepare to leave
                            this.dockingTime = 300 + Math.floor(Math.random() * 500);
                            this.headingToSea = true;
                            this.direction = -1;
                        } else {
                            this.direction = -1;
                        }
                    } else if (this.progress <= 0) {
                        this.progress = 0;

                        if (this.routeIndex === 0 && this.headingToSea) {
                            // Ship reached the sea - reset for new journey
                            this.destinationRoute = destinationRoutes[Math.floor(Math.random() * destinationRoutes.length)];
                            this.headingToSea = false;
                            this.direction = 1;
                            this.dockingTime = 100 + Math.floor(Math.random() * 200);
                        } else if (this.routeIndex === this.destinationRoute && !this.headingToSea) {
                            // Arrived at destination (start of route) - dock
                            this.dockingTime = 300 + Math.floor(Math.random() * 500);
                            this.headingToSea = true;
                            this.direction = 1;
                        } else {
                            this.direction = 1;
                        }
                    }
                }

                getPosition() {
                    const routeLen = this.route.length;
                    const totalDist = routeLen - 1;
                    const exactIdx = this.progress * totalDist;
                    const idx = Math.floor(exactIdx);
                    const t = exactIdx - idx;

                    if (idx >= routeLen - 1) {
                        const lastPt = this.route[routeLen - 1];
                        return { lat: lastPt.lat, lng: lastPt.lng, angle: 0, offsetX: 0, offsetY: 0 };
                    }

                    const p1 = this.route[idx];
                    const p2 = this.route[idx + 1];
                    const lat = p1.lat + (p2.lat - p1.lat) * t;
                    const lng = p1.lng + (p2.lng - p1.lng) * t;

                    // Calculate angle based on pixel positions for correct rotation
                    const pt1 = harborMap.latLngToContainerPoint([p1.lat, p1.lng]);
                    const pt2 = harborMap.latLngToContainerPoint([p2.lat, p2.lng]);
                    const angle = Math.atan2(pt2.y - pt1.y, pt2.x - pt1.x);

                    // Lane offset: perpendicular to route direction
                    // Heading to sea = right side (positive offset)
                    // Coming from sea = left side (negative offset)
                    const laneOffset = 8; // pixels
                    const perpAngle = angle + Math.PI / 2;
                    const offsetMultiplier = this.headingToSea ? 1 : -1;
                    const offsetX = Math.cos(perpAngle) * laneOffset * offsetMultiplier;
                    const offsetY = Math.sin(perpAngle) * laneOffset * offsetMultiplier;

                    return { lat, lng, angle: this.direction > 0 ? angle : angle + Math.PI, offsetX, offsetY };
                }

                draw(ctx) {
                    const pos = this.getPosition();
                    const point = harborMap.latLngToContainerPoint([pos.lat, pos.lng]);
                    const x = point.x + (pos.offsetX || 0);
                    const y = point.y + (pos.offsetY || 0);
                    const angle = pos.angle;
                    const size = this.size;

                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(angle);

                    // Draw ship shape - yellow ships (subtle)
                    ctx.fillStyle = 'rgba(225, 200, 90, 0.4)';
                    ctx.strokeStyle = 'rgba(180, 160, 70, 0.3)';
                    ctx.lineWidth = 0.8;
                    ctx.beginPath();

                    const length = size * 3;
                    const width = size * 1.2;

                    ctx.moveTo(-length / 2, -width / 2);
                    ctx.lineTo(-length / 2, width / 2);
                    ctx.lineTo(length / 3, width / 2);
                    ctx.lineTo(length / 2, 0);
                    ctx.lineTo(length / 3, -width / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();

                    ctx.restore();
                }
            }

            // Ship routes based on user's hand-drawn corrections
            // Map center: [52.410, 4.78], zoom 14
            const routes = [
                // Route 0 - ROOD: Noordzeekanaal - curves from top-left to bottom-right (4% toegevoegd links, schuin omhoog)
                [
                    { lat: 52.444, lng: 4.695 },
                    { lat: 52.435403, lng: 4.714725 },
                    { lat: 52.429859, lng: 4.748499 },
                    { lat: 52.424416, lng: 4.792067 },
                    { lat: 52.419864, lng: 4.825181 },
                    { lat: 52.416766, lng: 4.853253 },
                    { lat: 52.413639, lng: 4.864332 },
                    { lat: 52.405, lng: 4.880 },
                    { lat: 52.395, lng: 4.895 },
                    { lat: 52.385, lng: 4.910 }
                ],
                // Route 1 - GROEN: Verticale haven links (gehalveerd, 8% naar links, iets omhoog)
                [
                    { lat: 52.431, lng: 4.746 },
                    { lat: 52.421, lng: 4.747 },
                    { lat: 52.413, lng: 4.748 }
                ],
                // Route 2 - BLAUW: Verticale haven midden (20% langer aan onderkant)
                [
                    { lat: 52.427, lng: 4.769 },
                    { lat: 52.414, lng: 4.776 },
                    { lat: 52.403, lng: 4.776 }
                ],
                // Route 3 - GEEL: Horizontale tak (tegen blauwe lijn, net onder knik, gehalveerd)
                [
                    { lat: 52.410, lng: 4.776 },
                    { lat: 52.410, lng: 4.796 }
                ],
                // Route 4 - ROZE: Horizontale tak (tegen onderkant blauwe lijn, gehalveerd, 10% korter rechts)
                [
                    { lat: 52.403, lng: 4.776 },
                    { lat: 52.403, lng: 4.794 }
                ],
                // Route 5 - TURQUOISE: iets korter aan bovenkant
                [
                    { lat: 52.421, lng: 4.812 },
                    { lat: 52.400, lng: 4.822 },
                    { lat: 52.396, lng: 4.822 },
                    { lat: 52.396, lng: 4.810 }
                ],
                // Route 6 - ORANJE: Horizontale tak
                [
                    { lat: 52.406, lng: 4.820 },
                    { lat: 52.406, lng: 4.830 }
                ],
                // Route 7: 6% onder oranje
                [
                    { lat: 52.399131, lng: 4.821352 },
                    { lat: 52.399000, lng: 4.833440 }
                ],
                // Route 8 - LIMEGROEN: iets korter aan onderkant
                [
                    { lat: 52.417932, lng: 4.841991 },
                    { lat: 52.408, lng: 4.847 },
                    { lat: 52.406, lng: 4.851 }
                ],
                // Route 9 - IJ waterway: diagonal channel going southeast
                [
                    { lat: 52.413639, lng: 4.864332 },
                    { lat: 52.405, lng: 4.880 },
                    { lat: 52.395, lng: 4.895 },
                    { lat: 52.385, lng: 4.910 }
                ],
                // Route 10 - Nieuwe lijn vanaf 9.1 (IJ waterway punt 1)
                [
                    { lat: 52.405, lng: 4.880 },
                    { lat: 52.398054, lng: 4.861730 }
                ]
            ];

            // Create ships - spread across all routes for immediate activity
            const ships = [];

            // Ship configurations: [routeIndex, progress, direction, headingToSea]
            const shipConfigs = [
                // Ships on main channel (route 0) - Noordzeekanaal
                [0, 0.05, 1, false],  // just entering from sea
                [0, 0.15, 1, false],  // entering harbor
                [0, 0.28, 1, false],  // heading in
                [0, 0.42, 1, false],  // mid channel heading in
                [0, 0.55, -1, true],  // heading back to sea
                [0, 0.68, -1, true],  // heading back
                [0, 0.82, -1, true],  // almost at sea
                [0, 0.95, -1, true],  // leaving harbor
                // Ships in harbors
                [1, 0.3, 1, false],   // green harbor
                [1, 0.8, -1, true],   // green harbor returning
                [2, 0.5, 1, false],   // blue harbor
                [3, 0.4, 1, false],   // yellow dock
                [4, 0.6, -1, true],   // pink dock returning
                [5, 0.3, 1, false],   // turquoise
                [5, 0.7, -1, true],   // turquoise returning
                [6, 0.5, 1, false],   // orange dock
                [7, 0.4, -1, true],   // new line dock
                [8, 0.6, 1, false],   // lime green
                [9, 0.3, 1, false],   // IJ waterway
                [9, 0.6, -1, true],   // IJ waterway returning
                [10, 0.4, 1, false],  // route 10
                [10, 0.7, -1, true],  // route 10 returning
            ];

            for (let i = 0; i < shipConfigs.length; i++) {
                const [routeIdx, progress, direction, headingToSea] = shipConfigs[i];
                const speed = 0.00003 + Math.random() * 0.00002; // Very slow realistic ship speed
                const size = 7 + Math.random() * 7;
                const ship = new Ship(speed, size);

                ship.routeIndex = routeIdx;
                ship.route = routes[routeIdx];
                ship.progress = progress + (Math.random() * 0.1 - 0.05); // Small variation
                ship.direction = direction;
                ship.headingToSea = headingToSea;
                ship.destinationRoute = headingToSea ? 0 : (routeIdx === 0 ? destinationRoutes[Math.floor(Math.random() * destinationRoutes.length)] : routeIdx);
                ship.dockingTime = 0;
                ship.transitionCooldown = 0;

                ships.push(ship);
            }

            // Static ships (docked, not moving)
            // Format: { lat, lng, angle (degrees), size }
            const staticShips = [
                { lat: 52.401684, lng: 4.856175, angle: 40, size: 10 },
                { lat: 52.414718, lng: 4.767759, angle: -14, size: 10 },
                { lat: 52.409764, lng: 4.835748, angle: -50, size: 16 },
                { lat: 52.419558, lng: 4.742604, angle: -16, size: 10 },
                { lat: 52.411811, lng: 4.858598, angle: -45, size: 10 },
                { lat: 52.419385, lng: 4.799986, angle: -30, size: 10 }
            ];

            // Special Photo 8 boat - starts docked, sails when interlude is reached
            const photo8Boat = {
                route: [
                    { lat: 52.422226, lng: 4.838971 }, // Start (aangemeerd)
                    { lat: 52.419968, lng: 4.840094 }, // Punt 1
                    { lat: 52.419015, lng: 4.837089 }, // Punt 2
                    { lat: 52.422430, lng: 4.811068 }, // Punt 3
                    { lat: 52.402291, lng: 4.819610 }  // Eindpunt
                ],
                progress: 0,        // 0 = start, 1 = end
                isSailing: false,   // Starts docked
                opacity: 1,         // For fade out effect
                isFadingOut: false, // Fade state
                speed: 0.00012,     // Slow speed similar to other ships
                size: 12,           // Slightly larger than regular ships

                // Get current position along route
                getPosition() {
                    const route = this.route;
                    if (route.length < 2) return route[0];

                    // Calculate total route length and find current segment
                    let totalLength = 0;
                    const segmentLengths = [];

                    for (let i = 0; i < route.length - 1; i++) {
                        const dx = route[i + 1].lng - route[i].lng;
                        const dy = route[i + 1].lat - route[i].lat;
                        const len = Math.sqrt(dx * dx + dy * dy);
                        segmentLengths.push(len);
                        totalLength += len;
                    }

                    // Find position at current progress
                    let targetDist = this.progress * totalLength;
                    let accumulated = 0;

                    for (let i = 0; i < segmentLengths.length; i++) {
                        if (accumulated + segmentLengths[i] >= targetDist) {
                            const segmentProgress = (targetDist - accumulated) / segmentLengths[i];
                            return {
                                lat: route[i].lat + (route[i + 1].lat - route[i].lat) * segmentProgress,
                                lng: route[i].lng + (route[i + 1].lng - route[i].lng) * segmentProgress
                            };
                        }
                        accumulated += segmentLengths[i];
                    }

                    return route[route.length - 1]; // At end
                },

                // Get angle for ship rotation based on current segment
                getAngle() {
                    const route = this.route;
                    if (route.length < 2) return 0;

                    // Find current segment based on progress
                    let totalLength = 0;
                    const segmentLengths = [];

                    for (let i = 0; i < route.length - 1; i++) {
                        const p1 = harborMap.latLngToContainerPoint([route[i].lat, route[i].lng]);
                        const p2 = harborMap.latLngToContainerPoint([route[i + 1].lat, route[i + 1].lng]);
                        const len = Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2);
                        segmentLengths.push(len);
                        totalLength += len;
                    }

                    let targetDist = this.progress * totalLength;
                    let accumulated = 0;

                    for (let i = 0; i < segmentLengths.length; i++) {
                        if (accumulated + segmentLengths[i] >= targetDist || i === segmentLengths.length - 1) {
                            // Use this segment's direction
                            const p1 = harborMap.latLngToContainerPoint([route[i].lat, route[i].lng]);
                            const p2 = harborMap.latLngToContainerPoint([route[i + 1].lat, route[i + 1].lng]);
                            return Math.atan2(p2.y - p1.y, p2.x - p1.x);
                        }
                        accumulated += segmentLengths[i];
                    }
                    return 0;
                },

                update() {
                    if (!this.isSailing) return;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        this.isSailing = false; // Stop at end
                        return;
                    }
                    this.progress += this.speed;
                },

                draw(ctx) {
                    if (this.opacity <= 0) return; // Don't draw if fully faded

                    const pos = this.getPosition();
                    const point = harborMap.latLngToContainerPoint([pos.lat, pos.lng]);
                    const angle = this.getAngle();

                    ctx.save();
                    ctx.globalAlpha = this.opacity;
                    ctx.translate(point.x, point.y);
                    ctx.rotate(angle);

                    // Draw ship shape - same color as other ships
                    ctx.fillStyle = 'rgba(225, 200, 90, 0.4)';
                    ctx.strokeStyle = 'rgba(180, 160, 70, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();

                    const length = this.size * 3;
                    const width = this.size * 1.2;

                    ctx.moveTo(-length / 2, -width / 2);
                    ctx.lineTo(-length / 2, width / 2);
                    ctx.lineTo(length / 3, width / 2);
                    ctx.lineTo(length / 2, 0);
                    ctx.lineTo(length / 3, -width / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();

                    ctx.restore();
                },

                // Start fade out animation
                startFadeOut() {
                    this.isFadingOut = true;
                },

                // Reset to start position (called after fade completes)
                reset() {
                    this.progress = 0;
                    this.isSailing = false;
                    this.opacity = 1;
                    this.isFadingOut = false;
                },

                // Start sailing
                startSailing() {
                    if (this.progress >= 1) {
                        this.progress = 0; // Reset if already at end
                    }
                    this.opacity = 1;
                    this.isFadingOut = false;
                    this.isSailing = true;
                }
            };

            // Special Photo 9 boat - on Noordzeekanaal (red line / Route 0), sails west towards sea
            const photo9Boat = {
                // Route follows Route 0 (red line) reversed - sailing west towards sea
                route: [
                    { lat: 52.424416, lng: 4.792067 },  // Start (oost, op Route 0)
                    { lat: 52.429859, lng: 4.748499 },  // Via Route 0 punt
                    { lat: 52.435403, lng: 4.714725 },  // Via Route 0 punt
                    { lat: 52.444, lng: 4.695 }         // Eind (west, zee)
                ],
                progress: 0,
                isSailing: false,
                opacity: 1,         // For fade out effect
                isFadingOut: false, // Fade state
                speed: 0.00010,     // Iets langzamer dan foto 8 boot
                size: 14,           // Groter schip op hoofdvaarweg

                getPosition() {
                    const route = this.route;
                    if (route.length < 2) return route[0];

                    let totalLength = 0;
                    const segmentLengths = [];

                    for (let i = 0; i < route.length - 1; i++) {
                        const dx = route[i + 1].lng - route[i].lng;
                        const dy = route[i + 1].lat - route[i].lat;
                        segmentLengths.push(Math.sqrt(dx * dx + dy * dy));
                        totalLength += segmentLengths[i];
                    }

                    let targetDist = this.progress * totalLength;
                    let accumulated = 0;

                    for (let i = 0; i < segmentLengths.length; i++) {
                        if (accumulated + segmentLengths[i] >= targetDist) {
                            const segmentProgress = (targetDist - accumulated) / segmentLengths[i];
                            return {
                                lat: route[i].lat + (route[i + 1].lat - route[i].lat) * segmentProgress,
                                lng: route[i].lng + (route[i + 1].lng - route[i].lng) * segmentProgress
                            };
                        }
                        accumulated += segmentLengths[i];
                    }
                    return route[route.length - 1];
                },

                getAngle() {
                    const route = this.route;
                    if (route.length < 2) return 0;

                    let totalLength = 0;
                    const segmentLengths = [];

                    for (let i = 0; i < route.length - 1; i++) {
                        const p1 = harborMap.latLngToContainerPoint([route[i].lat, route[i].lng]);
                        const p2 = harborMap.latLngToContainerPoint([route[i + 1].lat, route[i + 1].lng]);
                        segmentLengths.push(Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2));
                        totalLength += segmentLengths[i];
                    }

                    let targetDist = this.progress * totalLength;
                    let accumulated = 0;

                    for (let i = 0; i < segmentLengths.length; i++) {
                        if (accumulated + segmentLengths[i] >= targetDist || i === segmentLengths.length - 1) {
                            const p1 = harborMap.latLngToContainerPoint([route[i].lat, route[i].lng]);
                            const p2 = harborMap.latLngToContainerPoint([route[i + 1].lat, route[i + 1].lng]);
                            return Math.atan2(p2.y - p1.y, p2.x - p1.x);
                        }
                        accumulated += segmentLengths[i];
                    }
                    return 0;
                },

                update() {
                    if (!this.isSailing) return;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        this.isSailing = false;
                        return;
                    }
                    this.progress += this.speed;
                },

                draw(ctx) {
                    if (this.opacity <= 0) return; // Don't draw if fully faded

                    const pos = this.getPosition();
                    const point = harborMap.latLngToContainerPoint([pos.lat, pos.lng]);
                    const angle = this.getAngle();

                    ctx.save();
                    ctx.globalAlpha = this.opacity;
                    ctx.translate(point.x, point.y);
                    ctx.rotate(angle);

                    ctx.fillStyle = 'rgba(225, 200, 90, 0.4)';
                    ctx.strokeStyle = 'rgba(180, 160, 70, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();

                    const length = this.size * 3;
                    const width = this.size * 1.2;

                    ctx.moveTo(-length / 2, -width / 2);
                    ctx.lineTo(-length / 2, width / 2);
                    ctx.lineTo(length / 3, width / 2);
                    ctx.lineTo(length / 2, 0);
                    ctx.lineTo(length / 3, -width / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();

                    ctx.restore();
                },

                // Start fade out animation
                startFadeOut() {
                    this.isFadingOut = true;
                },

                reset() {
                    this.progress = 0;
                    this.isSailing = false;
                    this.opacity = 1;
                    this.isFadingOut = false;
                },

                startSailing() {
                    if (this.progress >= 1) {
                        this.progress = 0;
                    }
                    this.opacity = 1;
                    this.isFadingOut = false;
                    this.isSailing = true;
                }
            };

            // Expose boats globally for marker sync
            window.photo8Boat = photo8Boat;
            window.photo9Boat = photo9Boat;

            function drawStaticShips() {
                staticShips.forEach(ship => {
                    const point = harborMap.latLngToContainerPoint([ship.lat, ship.lng]);
                    const x = point.x;
                    const y = point.y;
                    const angle = ship.angle * Math.PI / 180; // Convert degrees to radians
                    const size = ship.size || 10;

                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(angle);

                    // Draw ship shape - same style as moving ships
                    ctx.fillStyle = 'rgba(225, 200, 90, 0.4)';
                    ctx.strokeStyle = 'rgba(180, 160, 70, 0.3)';
                    ctx.lineWidth = 0.8;
                    ctx.beginPath();

                    const length = size * 3;
                    const width = size * 1.2;

                    ctx.moveTo(-length / 2, -width / 2);
                    ctx.lineTo(-length / 2, width / 2);
                    ctx.lineTo(length / 3, width / 2);
                    ctx.lineTo(length / 2, 0);
                    ctx.lineTo(length / 3, -width / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();

                    ctx.restore();
                });
            }

            // Animation state
            let animationActive = true;
            let animationFrame = null;

            // DEBUG: Draw routes as lines to see where they are
            const DEBUG_ROUTES = false;

            function drawDebugRoutes() {
                if (!DEBUG_ROUTES) return;

                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#88ff00', '#0088ff', '#ff0088', '#8800ff'];

                routes.forEach((route, idx) => {
                    if (route.length < 2) return;

                    const color = colors[idx % colors.length];

                    // Teken de lijn
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;

                    const firstPoint = harborMap.latLngToContainerPoint([route[0].lat, route[0].lng]);
                    ctx.moveTo(firstPoint.x, firstPoint.y);

                    for (let i = 1; i < route.length; i++) {
                        const point = harborMap.latLngToContainerPoint([route[i].lat, route[i].lng]);
                        ctx.lineTo(point.x, point.y);
                    }

                    ctx.stroke();

                    // Teken genummerde markers op elk punt
                    route.forEach((coord, pointIdx) => {
                        const point = harborMap.latLngToContainerPoint([coord.lat, coord.lng]);

                        // Cirkel
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 12, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // Nummer
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${idx}.${pointIdx}`, point.x, point.y);
                    });
                });
            }

            function animate() {
                if (!animationActive) {
                    animationFrame = null;
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw debug routes first (underneath ships)
                drawDebugRoutes();

                // Draw static ships (docked)
                drawStaticShips();

                // Draw and update moving ships
                ships.forEach(ship => {
                    ship.update(ships); // Pass all ships for collision detection
                    ship.draw(ctx);
                });

                // Draw and update special photo boats
                photo8Boat.update();
                photo9Boat.update();

                // Handle fade-out animation
                if (photo8Boat.isFadingOut) {
                    photo8Boat.opacity -= 0.02;
                    if (photo8Boat.opacity <= 0) {
                        photo8Boat.opacity = 0;
                        photo8Boat.reset();
                    }
                }
                if (photo9Boat.isFadingOut) {
                    photo9Boat.opacity -= 0.02;
                    if (photo9Boat.opacity <= 0) {
                        photo9Boat.opacity = 0;
                        photo9Boat.reset();
                    }
                }

                photo8Boat.draw(ctx);
                photo9Boat.draw(ctx);

                animationFrame = requestAnimationFrame(animate);
            }

            // Keep animation running throughout page (stop only at end panel)
            function checkAnimationVisibility() {
                const shouldAnimate = currentIndex < allItems.length - 1; // Stop at end panel
                if (shouldAnimate && !animationActive) {
                    animationActive = true;
                    if (!animationFrame) animate();
                } else if (!shouldAnimate && animationActive) {
                    animationActive = false;
                }
            }

            const originalScrollFn = scrollToIndex;
            scrollToIndex = function(index) {
                originalScrollFn(index);
                checkAnimationVisibility();
            };

            animate();
        })();

        // ========================================
        // Map/Ships Background Throughout Page
        // ========================================
        (function() {
            const mapBg = document.getElementById('harborMap');
            const originalBg = document.getElementById('originalBackground');
            const shipCanvas = document.getElementById('shipCanvas');

            // Yellow sections where map/ships should be hidden
            const yellowSections = document.querySelectorAll('.abp-quote-panel, .abp-infographic-panel, .abp-text-photo-combo');

            // Calculate dynamic brightness based on photo number
            // Follows day/night cycle of photos: dark (night) -> light (day) -> dark (night)
            function getBackgroundBrightness(photoNum) {
                // Map brightness range: 0.22 (dark/night) to 0.65 (bright/day)
                // Ship opacity range: 0.3 (dark) to 0.85 (bright)
                // Shifted up so map is always visible

                let mapBrightness, shipOpacity;

                if (photoNum <= 10) {
                    // Photo 1-10: dark (night photos)
                    mapBrightness = 0.22;
                    shipOpacity = 0.3;
                } else if (photoNum <= 25) {
                    // Photo 10-25: gradually lighter (dawn to day)
                    const progress = (photoNum - 10) / 15;
                    mapBrightness = 0.22 + (0.43 * progress); // 0.22 -> 0.65
                    shipOpacity = 0.3 + (0.55 * progress);    // 0.3 -> 0.85
                } else if (photoNum <= 30) {
                    // Photo 25-30: peak brightness (midday)
                    mapBrightness = 0.65;
                    shipOpacity = 0.85;
                } else if (photoNum <= 46) {
                    // Photo 30-46: gradually darker (dusk to night)
                    const progress = (photoNum - 30) / 16;
                    mapBrightness = 0.65 - (0.43 * progress); // 0.65 -> 0.22
                    shipOpacity = 0.85 - (0.55 * progress);   // 0.85 -> 0.3
                } else {
                    // Photo 46+: dark (night)
                    mapBrightness = 0.22;
                    shipOpacity = 0.3;
                }

                return { mapBrightness, shipOpacity };
            }

            function updateBackgroundVisibility(index, state) {
                // Check if current item is a yellow section
                const currentItem = allItems[index];
                const isYellowSection = currentItem && (
                    currentItem.classList.contains('abp-quote-panel') ||
                    currentItem.classList.contains('abp-infographic-panel') ||
                    currentItem.classList.contains('abp-text-photo-combo')
                );

                // Check if at map interlude
                const isAtInterlude = currentItem && currentItem.id === 'mapInterlude';

                // Full prominence at intro (state 0 and 1)
                const isFullProminence = index === 0 && state < 2;

                if (isYellowSection) {
                    // Don't hide - yellow sections cover the background naturally
                    // Just reduce brightness for consistency
                    mapBg.classList.remove('hidden');
                    shipCanvas.classList.remove('hidden');
                    const mapTiles = mapBg.querySelector('.leaflet-tile-pane');
                    if (mapTiles) {
                        mapTiles.style.filter = 'grayscale(100%) brightness(0.2)';
                    }
                    shipCanvas.style.opacity = '0.3';
                } else {
                    // Show map and ships
                    mapBg.classList.remove('hidden');
                    shipCanvas.classList.remove('hidden');

                    // Apply brightness based on context
                    if (isFullProminence) {
                        // Intro: full brightness, no filter
                        mapBg.classList.remove('subtle');
                        shipCanvas.classList.remove('subtle');
                        const mapTiles = mapBg.querySelector('.leaflet-tile-pane');
                        if (mapTiles) {
                            mapTiles.style.filter = '';
                        }
                        shipCanvas.style.opacity = '';
                    } else {
                        // Normal scroll or interlude: apply dynamic brightness
                        mapBg.classList.remove('subtle');
                        shipCanvas.classList.remove('subtle');

                        const photoNum = getApproximatePhotoNumber(index);
                        let { mapBrightness, shipOpacity } = getBackgroundBrightness(photoNum);

                        // Boost brightness at interlude
                        if (isAtInterlude) {
                            mapBrightness = Math.min(0.6, mapBrightness + 0.15);
                            shipOpacity = Math.min(0.8, shipOpacity + 0.15);
                        }

                        // Apply dynamic values via inline style
                        const mapTiles = mapBg.querySelector('.leaflet-tile-pane');
                        if (mapTiles) {
                            mapTiles.style.filter = `grayscale(100%) brightness(${mapBrightness})`;
                        }
                        shipCanvas.style.opacity = shipOpacity;
                    }
                }

                // Original background no longer needed - map is now the permanent background
                originalBg.classList.remove('visible');
            }

            // Desktop: hook into state changes
            if (window.innerWidth > 767) {
                // Initial state
                updateBackgroundVisibility(currentIndex, introState);

                // Hook into scroll updates
                const origScrollToIndex = scrollToIndex;
                scrollToIndex = function(index) {
                    origScrollToIndex(index);
                    updateBackgroundVisibility(index, introState);
                };

                // Hook into intro state changes
                const origSetIntroState = setIntroState;
                setIntroState = function(state) {
                    origSetIntroState(state);
                    updateBackgroundVisibility(currentIndex, state);
                };
            } else {
                // Mobile: scroll-based fading (keep original behavior - hide after intro)
                const introSection = document.querySelector('.abp-intro-section');

                function updateMobileBackground() {
                    const scrollY = window.scrollY;
                    const introHeight = introSection ? introSection.offsetHeight : window.innerHeight;

                    // Fade out when scrolled past intro section
                    if (scrollY > introHeight * 0.5) {
                        mapBg.classList.add('hidden');
                        shipCanvas.classList.add('hidden');
                    } else {
                        mapBg.classList.remove('hidden');
                        shipCanvas.classList.remove('hidden');
                    }
                }

                window.addEventListener('scroll', updateMobileBackground, { passive: true });
                updateMobileBackground();
            }
        })();

        // ========================================
        // Map Interlude - Photo Location Markers
        // ========================================
        (function() {
            if (window.innerWidth <= 767) return; // Skip on mobile

            const mapInterlude = document.getElementById('mapInterlude');
            if (!mapInterlude || !window.harborMap) return;

            // Photo locations with coordinates from Google Maps
            const photoLocations = [
                { photo: 1, lat: 52.426835, lng: 4.746218, img: 'a-better-port/1.jpg' },
                { photo: 2, lat: 52.420081, lng: 4.741673, img: 'a-better-port/2.jpg' },
                { photo: 3, lat: 52.410448, lng: 4.821323, img: 'a-better-port/3.jpg' },
                { photo: 4, lat: 52.413653, lng: 4.817088, img: 'a-better-port/4.jpg' },
                { photo: 5, lat: 52.408797, lng: 4.839597, img: 'a-better-port/5.jpg' },
                { photo: 6, lat: 52.426332, lng: 4.834396, img: 'a-better-port/6.jpg' },
                // Foto 7 heeft geen marker
                { photo: 8, lat: 52.418076, lng: 4.813868, img: 'a-better-port/8.jpg' },
                { photo: 9, lat: 52.433227, lng: 4.723632, img: 'a-better-port/9.jpg' },
                { photo: 10, lat: 52.411583, lng: 4.852021, img: 'a-better-port/10.jpg' },
                { photo: 11, lat: 52.400800, lng: 4.792068, img: 'a-better-port/11.jpg' },
                { photo: 12, lat: 52.399576, lng: 4.793432, img: 'a-better-port/12.jpg' },
                { photo: 13, lat: 52.410325, lng: 4.836279, img: 'a-better-port/13.jpg' },
                { photo: 14, lat: 52.410325, lng: 4.836278, img: 'a-better-port/14.jpg' },
                { photo: 15, lat: 52.407172, lng: 4.816485, img: 'a-better-port/15.jpg' },
                { photo: 16, lat: 52.416560, lng: 4.770814, img: 'a-better-port/16.jpg' },
                { photo: 17, lat: 52.409532, lng: 4.846137, img: 'a-better-port/17.jpg' },
                { photo: 18, lat: 52.408674, lng: 4.818952, img: 'a-better-port/18.jpg' },
                { photo: 19, lat: 52.410946, lng: 4.742718, img: 'a-better-port/19.jpg' },
                { photo: 20, lat: 52.391867, lng: 4.831891, img: 'a-better-port/20.jpg' },
                { photo: 21, lat: 52.406842, lng: 4.832283, img: 'a-better-port/21.jpg' },
                { photo: 22, lat: 52.406842, lng: 4.832283, img: 'a-better-port/22.jpg' },
                { photo: 23, lat: 52.405872, lng: 4.849079, img: 'a-better-port/23.jpg' },
                { photo: 24, lat: 52.404565, lng: 4.846634, img: 'a-better-port/24.jpg' },
                { photo: 25, lat: 52.405752, lng: 4.852919, img: 'a-better-port/25.jpg' },
                { photo: 26, lat: 52.405752, lng: 4.852920, img: 'a-better-port/26.jpg' },
                { photo: 27, lat: 52.405752, lng: 4.852918, img: 'a-better-port/27.jpg' },
                { photo: 28, lat: 52.401529, lng: 4.788567, img: 'a-better-port/28.jpg' },
                // Foto 29 heeft geen marker (Friesland)
                { photo: 30, lat: 52.399980, lng: 4.812031, img: 'a-better-port/30.jpg' },
                { photo: 31, lat: 52.399974, lng: 4.809522, img: 'a-better-port/31.jpg' },
                { photo: 32, lat: 52.400108, lng: 4.807481, img: 'a-better-port/32.jpg' },
                { photo: 33, lat: 52.399782, lng: 4.807411, img: 'a-better-port/33.jpg' },
                { photo: 34, lat: 52.405832, lng: 4.788024, img: 'a-better-port/34.jpg' },
                { photo: 35, lat: 52.402139, lng: 4.787851, img: 'a-better-port/35.jpg' },
                { photo: 36, lat: 52.424968, lng: 4.762087, img: 'a-better-port/36.jpg' },
                { photo: 37, lat: 52.425064, lng: 4.836028, img: 'a-better-port/37.jpg' },
                { photo: 38, lat: 52.406178, lng: 4.799223, img: 'a-better-port/38.jpg' },
                { photo: 39, lat: 52.406178, lng: 4.799223, img: 'a-better-port/39.jpg' },
                { photo: 40, lat: 52.398583, lng: 4.809405, img: 'a-better-port/40.jpg' },
                { photo: 41, lat: 52.398846, lng: 4.807387, img: 'a-better-port/41.jpg' },
                { photo: 42, lat: 52.416022, lng: 4.836170, img: 'a-better-port/42.jpg' },
                { photo: 43, lat: 52.411622, lng: 4.740434, img: 'a-better-port/43.jpg' },
                { photo: 44, lat: 52.393235, lng: 4.822626, img: 'a-better-port/44.jpg' },
                { photo: 45, lat: 52.428301, lng: 4.742228, img: 'a-better-port/45.jpg' },
                { photo: 46, lat: 52.381402, lng: 4.895790, img: 'a-better-port/46.jpg' },
            ];

            // Create marker layer group
            const markerGroup = L.layerGroup();
            let markersAdded = false;

            // Custom marker icon
            const markerIcon = L.divIcon({
                className: 'abp-photo-marker',
                html: '<div class="abp-photo-marker-icon"></div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -15]
            });

            // Reference to photo 8 and 9 markers for boat sync
            let photo8Marker = null;
            let photo9Marker = null;

            // Create markers with staggered animation
            photoLocations.forEach((loc, index) => {
                // Create custom icon with animation delay
                const delay = index * 0.08; // 80ms stagger between markers
                const customIcon = L.divIcon({
                    className: 'abp-photo-marker',
                    html: `<div class="abp-photo-marker-icon" style="animation-delay: ${delay}s"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -15]
                });

                // Photo 8 and 9 markers start at boat positions
                const isPhoto8 = loc.photo === 8;
                const isPhoto9 = loc.photo === 9;
                let startPos = [loc.lat, loc.lng];
                if (isPhoto8 && window.photo8Boat) {
                    startPos = [window.photo8Boat.route[0].lat, window.photo8Boat.route[0].lng];
                } else if (isPhoto9 && window.photo9Boat) {
                    startPos = [window.photo9Boat.route[0].lat, window.photo9Boat.route[0].lng];
                }

                const marker = L.marker(startPos, { icon: customIcon });

                const popupContent = `
                    <div class="abp-marker-popup-content">
                        <img src="${loc.img}" alt="Foto ${loc.photo}" class="abp-marker-thumbnail">
                        <div class="abp-marker-info">
                            <div class="abp-marker-title">Foto ${loc.photo}</div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    className: 'abp-marker-popup',
                    closeButton: false,
                    maxWidth: 200
                });

                marker.on('mouseover', function() { this.openPopup(); });
                marker.on('mouseout', function() { this.closePopup(); });

                markerGroup.addLayer(marker);

                // Store reference to photo 8 and 9 markers
                if (isPhoto8) {
                    photo8Marker = marker;
                }
                if (isPhoto9) {
                    photo9Marker = marker;
                }
            });

            // Update photo 8 marker position to follow boat
            function updatePhoto8MarkerPosition() {
                if (photo8Marker && window.photo8Boat) {
                    const pos = window.photo8Boat.getPosition();
                    photo8Marker.setLatLng([pos.lat, pos.lng]);
                }
            }

            // Update photo 9 marker position to follow boat
            function updatePhoto9MarkerPosition() {
                if (photo9Marker && window.photo9Boat) {
                    const pos = window.photo9Boat.getPosition();
                    photo9Marker.setLatLng([pos.lat, pos.lng]);
                }
            }

            // Animation frame for marker sync (runs when boats are active or fading)
            let markerSyncFrame = null;
            function syncMarkerWithBoat() {
                updatePhoto8MarkerPosition();
                updatePhoto9MarkerPosition();
                const boat8Active = window.photo8Boat && (window.photo8Boat.isSailing || window.photo8Boat.isFadingOut);
                const boat9Active = window.photo9Boat && (window.photo9Boat.isSailing || window.photo9Boat.isFadingOut);
                if (boat8Active || boat9Active) {
                    markerSyncFrame = requestAnimationFrame(syncMarkerWithBoat);
                } else {
                    // Final update after fade complete to ensure markers are at start
                    updatePhoto8MarkerPosition();
                    updatePhoto9MarkerPosition();
                    markerSyncFrame = null;
                }
            }

            // Show/hide markers and enhance map at interlude
            let interludeWheelHandler = null;
            const mapEl = document.getElementById('harborMap');
            const shipEl = document.getElementById('shipCanvas');
            const interludeOverlay = document.getElementById('mapInterludeOverlay');

            // Wheel handler for when map is elevated - use same threshold logic as main handler
            function handleInterludeWheel(e) {
                e.preventDefault();
                e.stopPropagation();

                const delta = Math.abs(e.deltaY);
                const direction = e.deltaY > 0 ? 1 : -1;
                const now = Date.now();
                const timeSinceLastScroll = now - lastScrollTime;
                lastScrollTime = now;

                if (isAnimating) return;

                // Detect mouse wheel: large delta after a pause
                if (timeSinceLastScroll > SCROLL_PAUSE && delta >= MOUSE_WHEEL_DELTA) {
                    triggerScroll(direction, true); // fast cooldown for mouse wheel
                    accumulatedDelta = 0;
                    lastDelta = 0;
                    return;
                }

                // Reset after pause (new scroll action)
                if (timeSinceLastScroll > SCROLL_PAUSE) {
                    lastDelta = 0;
                    accumulatedDelta = 0;
                }

                // Momentum detection: ignore decreasing deltas (trackpad coasting)
                if (lastDelta > 0 && delta < lastDelta * MOMENTUM_THRESHOLD) {
                    lastDelta = delta;
                    return;
                }

                // Reset if direction changes
                if (scrollDirection !== 0 && direction !== scrollDirection) {
                    accumulatedDelta = 0;
                }

                scrollDirection = direction;
                accumulatedDelta += delta;
                lastDelta = delta;

                // Trigger scroll when threshold reached
                if (accumulatedDelta >= DELTA_THRESHOLD) {
                    triggerScroll(direction);
                }
            }

            // Zoom controls
            const zoomControls = document.getElementById('zoomControls');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const zoomResetBtn = document.getElementById('zoomResetBtn');

            // Store original map view for reset
            const originalView = {
                center: [52.410, 4.78],
                zoom: 14
            };

            // Zoom button handlers
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    harborMap.zoomIn();
                });
            }
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    harborMap.zoomOut();
                });
            }
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('click', () => {
                    harborMap.setView(originalView.center, originalView.zoom);
                });
            }

            function updateMapInterlude(index) {
                const currentItem = allItems[index];
                const isAtInterlude = currentItem && currentItem.id === 'mapInterlude';

                if (isAtInterlude) {
                    // Show markers
                    if (!markersAdded) {
                        markerGroup.addTo(harborMap);
                        markersAdded = true;
                    }
                    // Make map more visible
                    mapEl.classList.remove('subtle');
                    mapEl.classList.add('interlude');
                    shipEl.classList.remove('subtle');
                    shipEl.classList.add('interlude');

                    // Show overlay text
                    if (interludeOverlay) {
                        interludeOverlay.classList.add('visible');
                    }

                    // Hide nav during map interlude
                    const navEl = document.querySelector('.horizontal-nav');
                    if (navEl) {
                        navEl.classList.add('map-active');
                    }

                    // Show zoom controls
                    if (zoomControls) {
                        zoomControls.classList.add('visible');
                    }

                    // Enable map dragging
                    harborMap.dragging.enable();

                    // Capture wheel events on elevated map and pass to scroll system
                    if (!interludeWheelHandler) {
                        interludeWheelHandler = handleInterludeWheel;
                        mapEl.addEventListener('wheel', interludeWheelHandler, { passive: false });
                    }

                    // Start photo 8 and 9 boats sailing
                    if (window.photo8Boat && !window.photo8Boat.isSailing) {
                        window.photo8Boat.startSailing();
                    }
                    if (window.photo9Boat && !window.photo9Boat.isSailing) {
                        window.photo9Boat.startSailing();
                    }
                    // Start marker sync animation
                    if (!markerSyncFrame) {
                        syncMarkerWithBoat();
                    }
                } else {
                    // Hide markers
                    if (markersAdded) {
                        markerGroup.remove();
                        markersAdded = false;
                    }
                    // Remove interlude class
                    mapEl.classList.remove('interlude');
                    shipEl.classList.remove('interlude');

                    // Hide overlay text
                    if (interludeOverlay) {
                        interludeOverlay.classList.remove('visible');
                    }

                    // Show nav again
                    const navEl = document.querySelector('.horizontal-nav');
                    if (navEl) {
                        navEl.classList.remove('map-active');
                    }

                    // Hide zoom controls
                    if (zoomControls) {
                        zoomControls.classList.remove('visible');
                    }

                    // Disable map dragging and reset view
                    harborMap.dragging.disable();
                    harborMap.setView(originalView.center, originalView.zoom);

                    // Remove wheel handler
                    if (interludeWheelHandler) {
                        mapEl.removeEventListener('wheel', interludeWheelHandler);
                        interludeWheelHandler = null;
                    }

                    // Start fade out for photo 8 and 9 boats (they will reset after fade completes)
                    if (window.photo8Boat && !window.photo8Boat.isFadingOut) {
                        window.photo8Boat.startFadeOut();
                    }
                    if (window.photo9Boat && !window.photo9Boat.isFadingOut) {
                        window.photo9Boat.startFadeOut();
                    }
                }
            }

            // Hook into scroll
            const origScrollForMarkers = scrollToIndex;
            let interludeTimeout = null;
            scrollToIndex = function(index) {
                origScrollForMarkers(index);
                const currentItem = allItems[index];
                const isAtInterlude = currentItem && currentItem.id === 'mapInterlude';

                // Clear any pending timeout
                if (interludeTimeout) {
                    clearTimeout(interludeTimeout);
                    interludeTimeout = null;
                }

                if (isAtInterlude) {
                    // Delay interlude activation until scroll animation completes
                    interludeTimeout = setTimeout(() => {
                        updateMapInterlude(index);
                    }, 500);
                } else {
                    // Immediately deactivate when leaving interlude
                    updateMapInterlude(index);
                }
            };

            // Initial state
            updateMapInterlude(currentIndex);
        })();

        // ========================================
        // Progress Indicator
        // ========================================
        (function() {
            const progressNumber = document.getElementById('progressNumber');
            const scrollContainer = document.getElementById('scrollContainer');
            let currentProgress = 0;
            let targetProgress = 0;
            let progressInitialized = false;

            // Reset scroll to beginning on page load
            scrollContainer.scrollLeft = 0;

            function calculateProgress() {
                // Always return 0 during initialization
                if (!progressInitialized) return 0;

                const isMobile = window.innerWidth <= 767;

                if (isMobile) {
                    // Mobile: use vertical scroll (window scroll)
                    const scrollTop = window.scrollY || document.documentElement.scrollTop;
                    const maxScroll = document.documentElement.scrollHeight - window.innerHeight;

                    if (maxScroll > 0) {
                        const scrollProgress = (scrollTop / maxScroll) * 100;
                        return Math.round(scrollProgress);
                    }
                    return 0;
                } else {
                    // Desktop: use horizontal scroll
                    const scrollLeft = scrollContainer.scrollLeft;
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;

                    // If scroll has started (past intro section), calculate based on scroll position
                    if (scrollLeft > 50) {
                        // Scroll progress (3-100%)
                        const scrollProgress = maxScroll > 0 ? (scrollLeft / maxScroll) * 97 : 0;
                        return Math.round(3 + scrollProgress);
                    }

                    // Otherwise show intro state progress (0%, 1%, 2%)
                    return introState;
                }
            }

            function updateProgress() {
                // Animate the number smoothly
                if (currentProgress !== targetProgress) {
                    const diff = targetProgress - currentProgress;
                    const step = diff > 0 ? Math.max(1, Math.ceil(diff / 8)) : Math.min(-1, Math.floor(diff / 8));
                    currentProgress += step;

                    // Clamp to target if very close
                    if (Math.abs(targetProgress - currentProgress) <= 1) {
                        currentProgress = targetProgress;
                    }

                    progressNumber.textContent = Math.max(0, Math.min(100, currentProgress));
                }

                requestAnimationFrame(updateProgress);
            }

            // Initialize progress to 0
            targetProgress = 0;
            currentProgress = 0;
            progressNumber.textContent = '0';

            // Start animation loop
            requestAnimationFrame(updateProgress);

            // Enable progress calculation after a short delay to avoid load-time scroll events
            setTimeout(() => {
                progressInitialized = true;

                // Update progress on scroll (both horizontal for desktop and vertical for mobile)
                scrollContainer.addEventListener('scroll', () => {
                    targetProgress = calculateProgress();
                });

                // Also listen for window scroll on mobile
                window.addEventListener('scroll', () => {
                    if (window.innerWidth <= 767) {
                        targetProgress = calculateProgress();
                    }
                });

                // Hook into intro state changes
                const origSetIntroStateForProgress = setIntroState;
                setIntroState = function(state) {
                    origSetIntroStateForProgress(state);
                    targetProgress = calculateProgress();
                };
            }, 500);
        })();

        // Mobiel: nav auto-hide na 3 seconden, toon bij aanraking
        if (window.innerWidth <= 767) {
            const nav = document.querySelector('.horizontal-nav');
            let hideTimeout;

            function hideNav() {
                nav.classList.add('nav-hidden');
            }

            function showNav() {
                nav.classList.remove('nav-hidden');
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(hideNav, 3000);
            }

            hideTimeout = setTimeout(hideNav, 3000);
            document.addEventListener('touchstart', showNav, { passive: true });
        }
    </script>

    <!-- Share Functionality -->
    <script>
        (function() {
            const shareButton = document.getElementById('shareButton');
            const shareDropdown = document.getElementById('shareDropdown');
            if (!shareButton || !shareDropdown) return;

            const pageUrl = encodeURIComponent(window.location.href);
            const pageTitle = encodeURIComponent(document.title);

            shareButton.addEventListener('click', function(e) {
                e.stopPropagation();
                if (navigator.share) {
                    navigator.share({ title: document.title, url: window.location.href }).catch(() => {});
                    return;
                }
                shareDropdown.classList.toggle('active');
            });

            document.addEventListener('click', function() {
                shareDropdown.classList.remove('active');
            });

            shareDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${pageTitle}%20${pageUrl}`;
            document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`;
            document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${pageUrl}&text=${pageTitle}`;
            document.getElementById('shareLinkedIn').href = `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`;
            document.getElementById('shareEmail').href = `mailto:?subject=${pageTitle}&body=${pageUrl}`;

            document.getElementById('copyLink').addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    const span = this.querySelector('span');
                    span.textContent = 'Gekopieerd!';
                    this.classList.add('copy-success');
                    setTimeout(() => {
                        span.textContent = 'Kopieer link';
                        this.classList.remove('copy-success');
                    }, 2000);
                });
            });
        })();
    </script>
</body>
</html>
